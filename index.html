<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Moore Club - La Tentación Empieza Aquí</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: url('mooreclub1.webp') center top no-repeat;
      background-size: cover;
      background-attachment: fixed;
      color: white;
    }
    .bg-overlay { background-color: rgba(0, 0, 0, 0.85); }
    .btn {
      background-color: #6b21a8; color: white; padding: 0.5rem 1rem;
      border-radius: 0.375rem; font-weight: 600; cursor: pointer;
      transition: background-color 0.3s; margin-right: 0.5rem;
    }
    .btn:hover { background-color: #5b189b; }
    .producto-card img {
      border-radius: 0.5rem; height: 96px; width: 96px;
      object-fit: cover;
    }
    #contenido { min-height: 60vh; }
    .notification-dot {
        height: 8px; width: 8px; background-color: #ef4444;
        border-radius: 50%; position: absolute; top: 0; right: 0;
    }

    /* Estilos para el Chatbot */
    #chatbot-button {
        position: fixed;
        bottom: 40px; /* Más arriba */
        bottom: 150px; /* Más arriba, altura media */
        right: 20px;
        border-radius: 50%;
        width: 80px; /* Más grande */
        height: 80px; /* Más grande */
        width: 100px; /* Más grande */
        height: 100px; /* Más grande */
        overflow: hidden;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
        cursor: pointer;
@@ -62,10 +62,10 @@

    #chatbot-container {
        position: fixed;
        bottom: 120px; /* Encima del botón más grande */
        bottom: 260px; /* Encima del botón más grande (150px + 100px + 10px margen) */
        right: 20px;
        width: 400px; /* Más grande */
        height: 550px; /* Más grande */
        width: 450px; /* Más grande */
        height: 600px; /* Más grande */
        background-color: #1a1a2e;
        border-radius: 10px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
@@ -611,10 +611,11 @@

            if (empleado && hashPassword(pass) === empleado.passHash) {
                sessionStorage.setItem('currentUser', nombre);
                await gestionarReseteoDatos(nombre);
                await gestionarResionarReseteoDatos(nombre, true);
                mostrarPanelEmpleados(nombre);
                const datosFichaje = fichajes[nombre];
                await gestionarReseteoDatos(currentUser); // Esto gestiona fichajes
                // *** CORRECCIÓN DE ERROR AQUÍ: LA LÍNEA REPETIDA Y MAL ESCRITA FUE ELIMINADA ***
                await gestionarReseteoDatos(currentUser, true); // Esto gestiona ventas
                mostrarPanelEmpleados(currentUser);
                const datosFichaje = fichajes[currentUser];
                if (datosFichaje && datosFichaje.fichado) {
                    iniciarRelojFichaje(datosFichaje.inicio, datosFichaje.hoy, datosFichaje.semana, datosFichaje.total);
                }
@@ -747,431 +748,430 @@
            const cliente = document.getElementById(`cliente-hab-${id}`).value.trim();
            const fecha = document.getElementById(`fecha-hab-${id}`).value;
            const hora = document.getElementById(`hora-hab-${id}`).value;
            // CORRECCIÓN DEL SYNTAXERROR AQUÍ
            const duracion = parseInt(document.getElementById(`duracion-hab-${id}`).value);

            if (!cliente || !fecha || !hora || isNaN(duracion) || duracion <= 0) {
                alert("Por favor, rellena todos los campos y la duración.");
                return;
            }

            const [h, m] = hora.split(':');
            const inicioReserva = new Date(fecha);
            inicioReserva.setHours(parseInt(h), parseInt(m), 0, 0);
            const finReserva = new Date(inicioReserva.getTime() + duracion * 60 * 60 * 1000);

            const hayConflicto = hab.reservas.some(r => (inicioReserva.getTime() < r.fin) && (finReserva.getTime() > r.inicio));
            if (hayConflicto) {
                alert("Conflicto de horario. La habitación ya está reservada en ese tramo.");
                return;
            }

            hab.reservas.push({ id: Date.now(), cliente: cliente, inicio: inicioReserva.getTime(), fin: finReserva.getTime() });

            try {
                await setDoc(doc(db, 'habitaciones', String(hab.id)), hab);
                alert(`¡Reserva confirmada para ${cliente} en ${hab.nombre}!`);
                mostrarPanelHabitaciones();
            } catch (e) {
                console.error("Error al reservar habitación en Firestore:", e);
                alert("Error al confirmar la reserva. Por favor, inténtalo de nuevo.");
            }
        }

        window.cancelarReserva = async (habId, reservaId, nombreEmpleado) => {
            const hab = habitaciones.find(h => h.id === habId);
            if (!hab) return;

            const reservaIndex = hab.reservas.findIndex(r => r.id === reservaId);
            if (reservaIndex > -1) {
                if (confirm(`¿Seguro que quieres cancelar la reserva de '${hab.reservas[reservaIndex].cliente}'?`)) {
                    hab.reservas.splice(reservaIndex, 1);
                    try {
                        await setDoc(doc(db, 'habitaciones', String(hab.id)), hab);
                        alert("Reserva cancelada.");
                        mostrarPanelEmpleados(nombreEmpleado);
                    } catch (e) {
                        console.error("Error al cancelar reserva en Firestore:", e);
                        alert("Error al cancelar la reserva. Por favor, inténtalo de nuevo.");
                    }
                }
            }
        }

        window.ocuparHabitacionAhora = async (id, nombreEmpleado) => {
            const hab = habitaciones.find(h => h.id === id);
            if (hab && getEstadoHabitacion(hab).estado === 'disponible') {
                const ahora = Date.now();
                const nuevaReserva = { id: ahora, cliente: 'Ocupación Directa', inicio: ahora, fin: ahora + 30 * 60 * 1000 };
                hab.reservas.push(nuevaReserva);
                try {
                    await setDoc(doc(db, 'habitaciones', String(hab.id)), hab);
                    alert(`Habitación ${hab.nombre} ocupada directamente.`);
                    mostrarPanelEmpleados(nombreEmpleado);
                } catch (e) {
                    console.error("Error al ocupar habitación en Firestore:", e);
                    alert("Error al ocupar la habitación. Por favor, inténtalo de nuevo.");
                }
            }
        }

        window.anadirTiempoHabitacion = async (id, nombreEmpleado) => {
            const hab = habitaciones.find(h => h.id === id);
            const ahora = Date.now();
            const reservaActual = hab.reservas.find(r => ahora >= r.inicio && ahora < r.fin);

            if (hab && reservaActual) {
                reservaActual.fin += 30 * 60 * 1000;
                try {
                    await setDoc(doc(db, 'habitaciones', String(hab.id)), hab);
                    alert(`Tiempo añadido a la habitación ${hab.nombre}.`);
                    mostrarPanelEmpleados(nombreEmpleado);
                } catch (e) {
                    console.error("Error al añadir tiempo a habitación en Firestore:", e);
                    alert("Error al añadir tiempo. Por favor, inténtalo de nuevo.");
                }
            }
        }

        window.liberarHabitacion = async (id, nombreEmpleado) => {
            const hab = habitaciones.find(h => h.id === id);
            const ahora = Date.now();
            const reservaActualIndex = hab.reservas.findIndex(r => ahora >= r.inicio && ahora < r.fin);

            if (reservaActualIndex > -1) {
                if (confirm(`¿Seguro que quieres liberar la habitación y finalizar la sesión de '${hab.reservas[reservaActualIndex].cliente}'?`)) {
                    hab.reservas.splice(reservaActualIndex, 1);
                    try {
                        await setDoc(doc(db, 'habitaciones', String(hab.id)), hab);
                        alert(`Habitación ${hab.nombre} liberada.`);
                        mostrarPanelEmpleados(nombreEmpleado);
                    } catch (e) {
                        console.error("Error al liberar habitación en Firestore:", e);
                        alert("Error al liberar la habitación. Por favor, inténtalo de nuevo.");
                    }
                }
            } else {
                alert("Esta habitación no tiene una ocupación activa para liberar.");
            }
        }

        window.publicarAnuncio = async () => {
            const texto = document.getElementById('anuncioTexto').value.trim();
            if (texto) {
                const nuevoAnuncio = { id: Date.now(), texto: texto };
                try {
                    await setDoc(doc(db, 'anuncios', String(nuevoAnuncio.id)), nuevoAnuncio);
                    anuncios.unshift(nuevoAnuncio);
                    document.getElementById('anuncioTexto').value = '';
                    alert('Anuncio publicado.');
                    mostrarPanelAdmin();
                } catch (e) {
                    console.error("Error al publicar anuncio en Firestore:", e);
                    alert("Error al publicar el anuncio. Por favor, inténtalo de nuevo.");
                }
            }
        }

        window.mostrarAnuncios = async (nombre) => {
            await cargarTodosLosAnuncios(); 

            let mensaje = "Últimos Anuncios:\n\n";
            if (anuncios.length === 0) {
                mensaje = "No hay anuncios recientes.";
            } else {
                anuncios.sort((a, b) => b.id - a.id).slice(0, 5).forEach(anuncio => {
                    mensaje += `- ${anuncio.texto}\n`;
                });
            }
            alert(mensaje);
            marcarAnunciosComoVistos(nombre);
        }

        window.marcarAnunciosComoVistos = async (nombre) => {
            const empleado = empleados.find(e => e.nombre === nombre);
            if (empleado && anuncios.length > 0) {
                empleado.ultimoAnuncioVisto = anuncios[0].id;
                try {
                    await setDoc(doc(db, 'empleados', nombre), empleado);
                    mostrarPanelEmpleados(nombre);
                } catch (e) {
                    console.error("Error al marcar anuncio visto en Firestore:", e);
                }
            }
        }

        window.comprobarNuevosAnuncios = async (nombre) => {
            const empleado = empleados.find(e => e.nombre === nombre);
            if (!empleado) return false;

            await cargarTodosLosAnuncios();

            if (anuncios.length === 0) return false;
            const ultimoAnuncioId = anuncios[0].id;
            return empleado.ultimoAnuncioVisto !== ultimoAnuncioId;
        }

        window.anadirAlLibroNegro = async () => {
            const nombre = document.getElementById('libroNombre').value.trim();
            const relacion = document.getElementById('libroRelacion').value;
            const notas = document.getElementById('libroNotas').value.trim();
            if (!nombre) {
                alert("El nombre del contacto es obligatorio.");
                return;
            }
            const nuevoContacto = { id: Date.now(), nombre, relacion, notas };
            try {
                await setDoc(doc(collection(db, 'libroNegro')), nuevoContacto);
                libroNegro.push(nuevoContacto);
                actualizarLibroNegro();
                document.getElementById('libroNombre').value = '';
                document.getElementById('libroNotas').value = '';
            } catch (e) {
                console.error("Error al añadir al Libro Negro en Firestore:", e);
                alert("Error al añadir el contacto. Por favor, inténtalo de nuevo.");
            }
        }

        window.eliminarDelLibro = async (id) => {
            try {
                await deleteDoc(doc(db, 'libroNegro', String(id)));
                libroNegro = libroNegro.filter(c => c.id !== id);
                actualizarLibroNegro();
            } catch (e) {
                console.error("Error al eliminar del Libro Negro en Firestore:", e);
                alert("Error al eliminar el contacto. Por favor, inténtalo de nuevo.");
            }
        }

        window.actualizarLibroNegro = () => {
            const lista = document.getElementById('listaLibroNegro');
            if (!lista) return;
            lista.innerHTML = '';
            libroNegro.forEach(contacto => {
                lista.innerHTML += `<li class="flex justify-between items-center p-2 bg-purple-800 rounded"><span><strong class="capitalize">${contacto.nombre}</strong> (${contacto.relacion}) - ${contacto.notas}</span><button onclick="eliminarDelLibro(${contacto.id})" class="text-red-500 font-bold px-2">X</button></li>`;
            });
        }

        window.anadirAListaNegra = async () => {
            const nombre = document.getElementById('vetadoNombre').value.trim();
            const motivo = document.getElementById('vetadoMotivo').value.trim();
            if (!nombre || !motivo) {
                alert("El nombre y el motivo son obligatorios.");
                return;
            }
            const nuevaPersona = { id: Date.now(), nombre, motivo };
            try {
                await setDoc(doc(collection(db, 'listaNegra')), nuevaPersona);
                listaNegra.push(nuevaPersona);
                actualizarListaNegra();
                document.getElementById('vetadoNombre').value = '';
                document.getElementById('vetadoMotivo').value = '';
            } catch (e) {
                console.error("Error al añadir a la Lista Negra en Firestore:", e);
                alert("Error al añadir a la lista. Por favor, inténtalo de nuevo.");
            }
        }

        window.eliminarDeListaNegra = async (id) => {
            try {
                await deleteDoc(doc(db, 'listaNegra', String(id)));
                listaNegra = listaNegra.filter(p => p.id !== id);
                actualizarListaNegra();
            } catch (e) {
                console.error("Error al eliminar de la Lista Negra en Firestore:", e);
                alert("Error al eliminar. Por favor, inténtalo de nuevo.");
            }
        }

        window.actualizarListaNegra = () => {
            const lista = document.getElementById('listaDeVetados');
            if (!lista) return;
            lista.innerHTML = '';
            listaNegra.forEach(persona => {
                lista.innerHTML += `<li class="flex justify-between items-center p-2 bg-red-900 bg-opacity-50 rounded"><span><strong class="capitalize">${persona.nombre}</strong> - ${persona.motivo}</span><button onclick="eliminarDeListaNegra(${persona.id})" class="text-white font-bold px-2">X</button></li>`;
            });
        }

        window.mostrarListaNegraPublica = async () => {
            await cargarListaNegra();

            let mensaje = "--- LISTA NEGRA ---\nPersonas con acceso denegado al local:\n\n";
            if (listaNegra.length === 0) {
                mensaje += "Actualmente no hay nadie en la lista negra.";
            } else {
                listaNegra.forEach(p => {
                    mensaje += `- ${p.nombre} (Motivo: ${p.motivo})\n`;
                });
            }
            alert(mensaje);
        }

        // ===================================================================================
        //  NUEVAS FUNCIONES DE CARGA ASÍNCRONA DESDE FIRESTORE
        // ===================================================================================

        async function cargarTodosLosEmpleados() {
            try {
                const empleadosSnapshot = await getDocs(collection(db, 'empleados'));
                empleados = [];
                if (!empleadosSnapshot.empty) {
                    empleadosSnapshot.forEach(doc => {
                        empleados.push(doc.data());
                    });
                } else {
                    empleados = [
                        {nombre: 'tito giovanni', passHash: hashPassword('1234'), ultimoAnuncioVisto: 0},
                        {nombre: 'marta', passHash: hashPassword('1234'), ultimoAnuncioVisto: 0}
                    ];
                    for (const emp of empleados) {
                        await setDoc(doc(db, 'empleados', emp.nombre), emp);
                    }
                    console.log("Empleados por defecto creados en Firestore.");
                }
                console.log("Empleados cargados desde Firestore:", empleados);
            } catch (e) {
                console.error("Error al cargar empleados desde Firestore:", e);
                if (!empleados || empleados.length === 0) {
                    empleados = [
                        {nombre: 'tito giovanni', passHash: hashPassword('1234'), ultimoAnuncioVisto: 0},
                        {nombre: 'marta', passHash: hashPassword('1234'), ultimoAnuncioVisto: 0}
                    ];
                }
            }
        }

        async function cargarTodosLosFichajes() {
            try {
                const fichajesSnapshot = await getDocs(collection(db, 'fichajes'));
                fichajes = {};
                fichajesSnapshot.forEach(doc => {
                    fichajes[doc.id] = doc.data();
                });
                console.log("Fichajes cargados desde Firestore:", fichajes);
            } catch (e) {
                console.error("Error al cargar fichajes desde Firestore:", e);
                fichajes = {};
            }
        }

        async function cargarTodasLasVentas() {
            try {
                const ventasSnapshot = await getDocs(collection(db, 'ventas'));
                ventas = {};
                ventasSnapshot.forEach(doc => {
                    ventas[doc.id] = doc.data();
                });
                console.log("Ventas cargadas desde Firestore:", ventas);
            } catch (e) {
                console.error("Error al cargar ventas desde Firestore:", e);
                ventas = {};
            }
        }

        async function cargarTodasLasHabitaciones() {
            try {
                const habitacionesSnapshot = await getDocs(collection(db, 'habitaciones'));
                habitaciones = [];
                if (!habitacionesSnapshot.empty) {
                    habitacionesSnapshot.forEach(doc => {
                        habitaciones.push(doc.data());
                    });
                    if (habitaciones.length < 10) {
                        for (let i = 1; i <= 10; i++) {
                            if (!habitaciones.find(h => h.id === i)) {
                                habitaciones.push({ id: i, nombre: `Habitación ${i}`, reservas: [] });
                            }
                        }
                    }
                    habitaciones.sort((a, b) => a.id - b.id);
                } else {
                    for (let i = 1; i <= 10; i++) {
                        const nuevaHab = { id: i, nombre: `Habitación ${i}`, reservas: [] };
                        habitaciones.push(nuevaHab);
                        await setDoc(doc(db, 'habitaciones', String(i)), nuevaHab);
                    }
                    console.log("Habitaciones por defecto creadas en Firestore.");
                }
                console.log("Habitaciones cargadas desde Firestore:", habitaciones);
            } catch (e) {
                console.error("Error al cargar habitaciones desde Firestore:", e);
                if (!habitaciones || habitaciones.length < 10) {
                    habitaciones = [];
                    for (let i = 1; i <= 10; i++) {
                        habitaciones.push({ id: i, nombre: `Habitación ${i}`, reservas: [] });
                    }
                }
            }
        }

        async function cargarTodosLosAnuncios() {
            try {
                const anunciosQuery = query(collection(db, 'anuncios'), orderBy('id', 'desc'));
                const anunciosSnapshot = await getDocs(anunciosQuery);
                anuncios = [];
                anunciosSnapshot.forEach(doc => {
                    anuncios.push(doc.data());
                });
                console.log("Anuncios cargados desde Firestore:", anuncios);
            } catch (e) {
                console.error("Error al cargar anuncios desde Firestore:", e);
                anuncios = [];
            }
        }

        async function cargarLibroNegro() {
            try {
                const libroNegroSnapshot = await getDocs(collection(db, 'libroNegro'));
                libroNegro = [];
                libroNegroSnapshot.forEach(doc => {
                    libroNegro.push(doc.data());
                });
                console.log("Libro Negro cargado desde Firestore:", libroNegro);
            } catch (e) {
                console.error("Error al cargar Libro Negro desde Firestore:", e);
                libroNegro = [];
            }
        }

        async function cargarListaNegra() {
            try {
                const listaNegraSnapshot = await getDocs(collection(db, 'listaNegra'));
                listaNegra = [];
                listaNegraSnapshot.forEach(doc => {
                    listaNegra.push(doc.data());
                });
                console.log("Lista Negra cargada desde Firestore:", listaNegra);
            } catch (e) {
                console.error("Error al cargar Lista Negra desde Firestore:", e);
                listaNegra = [];
            }
        }

        // ===================================================================================
        //  INICIALIZACIÓN PRINCIPAL - CARGA TODOS LOS DATOS AL INICIO
        // ===================================================================================
        console.log("Iniciando carga de datos desde Firestore...");
        await cargarTodosLosEmpleados();
        await cargarTodosLosFichajes();
        await cargarTodasLasVentas();
        await cargarTodasLasHabitaciones();
        await cargarTodosLosAnuncios();
        await cargarLibroNegro();
        await cargarListaNegra();
        console.log("Carga de datos desde Firestore completada.");


        const currentUser = sessionStorage.getItem('currentUser');
        if (currentUser && empleados.find(e => e.nombre === currentUser)) {
            await gestionarReseteoDatos(currentUser);
            await gestionarReseteoDatos(currentUser, true);
            mostrarPanelEmpleados(currentUser);
            const datosFichaje = fichajes[currentUser];
            if (datosFichaje && datosFichaje.fichado) {
                iniciarRelojFichaje(datosFichaje.inicio, datosFichaje.hoy, datosFichaje.semana, datosFichaje.total);
            }
        } else {
            mostrarInicio();
        }
    });
  </script></body></html>
