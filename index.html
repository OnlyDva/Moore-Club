<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Moore Club - La Tentación Empieza Aquí</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: url('mooreclub1.webp') center top no-repeat;
      background-size: cover;
      background-attachment: fixed;
      color: white;
    }
    .bg-overlay { background-color: rgba(0, 0, 0, 0.85); }
    .btn {
      background-color: #6b21a8; color: white; padding: 0.5rem 1rem;
      border-radius: 0.375rem; font-weight: 600; cursor: pointer;
      transition: background-color 0.3s; margin-right: 0.5rem;
    }
    .btn:hover { background-color: #5b189b; }
    .producto-card img {
      border-radius: 0.5rem; height: 96px; width: 96px;
      object-fit: cover;
    }
    #contenido { min-height: 60vh; }
    .notification-dot {
        height: 8px; width: 8px; background-color: #ef4444;
        border-radius: 50%; position: absolute; top: 0; right: 0;
    }
  </style>

  <script type="module">
    // Importa las funciones básicas de Firebase App y Firestore
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, setDoc, updateDoc, deleteDoc, getDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Tu configuración de Firebase (LA QUE TE DIO LA CONSOLA)
    const firebaseConfig = {
      apiKey: "AIzaSyAjSUwa9HtVsxBhY__73XdLbWXHmlcIyUE",
      authDomain: "moore-club.firebaseapp.com",
      projectId: "moore-club",
      storageBucket: "moore-club.firebasestorage.app",
      messagingSenderId: "674972089844",
      appId: "1:674972089844:web:9d6f9680bec8f6cff98da1",
      measurementId: "G-RSPNMJ466D"
    };

    // Inicializa Firebase
    const app = initializeApp(firebaseConfig);
    
    // Obtén una instancia de Firestore
    const db = getFirestore(app);

    // Exporta estas funciones para que sean accesibles globalmente desde tu script principal
    // (ya que tu script principal no es de tipo 'module')
    window.db = db;
    window.collection = collection;
    window.getDocs = getDocs;
    window.doc = doc;
    window.setDoc = setDoc;
    window.updateDoc = updateDoc;
    window.deleteDoc = deleteDoc;
    window.getDoc = getDoc;
    window.query = query; // Añadido para hacer consultas (ej. ordenar anuncios)
    window.orderBy = orderBy; // Añadido para hacer consultas (ej. ordenar anuncios)
  </script>
  </head>
<body class="text-purple-200">
  <div class="bg-overlay min-h-screen">
    <nav class="bg-purple-900 text-white px-6 py-4 flex justify-between items-center">
      <h1 class="text-xl font-bold cursor-pointer" onclick="mostrarInicio()">Moore Club</h1>
      <ul class="flex space-x-6 text-sm">
        <li><a href="#" onclick="mostrarInicio()" class="hover:underline">Inicio</a></li>
        <li><a href="#" onclick="mostrarLoginVIP()" class="hover:underline">Empleados</a></li>
        <li><a href="#" onclick="mostrarPanelProductos()" class="hover:underline">Productos</a></li>
        <li><a href="#" onclick="mostrarPanelHabitaciones()" class="hover:underline">Habitaciones</a></li>
      </ul>
    </nav>
    <main id="contenido" class="p-8"></main>
  </div>

  <script>
    // Se envuelve todo en el listener para asegurar que el DOM está listo
    document.addEventListener('DOMContentLoaded', async () => { // *** MANTENER 'async' AQUÍ ***
        // ===================================================================================
        //  1. FUENTE DE DATOS Y ESTADO GLOBAL
        // ===================================================================================
        const productos = [ { id: 'tito_griego', nombre: 'Tito Dios Griego', imagen: 'Tito.png' }, { id: 'la_tita', nombre: 'La Tita', imagen: 'Tita.png' }, { id: 'mascara_cat', nombre: 'Máscara Dominante “Cat Vanilla”', imagen: 'Mascara.png' }, { id: 'pinzas_led', nombre: 'Pinzas LED “Sweet Pain”', imagen: 'Pinzas.png' }, { id: 'preservativos', nombre: 'Preservativos “Espadas del Deseo”', imagen: 'condones.png' }, { id: 'dildo_doble', nombre: 'Dildo Doble “Fusión Morada”', imagen: 'Dildo.webp' }, { id: 'banana', nombre: 'Banana Pelada', imagen: 'banana.png' }, { id: 'magdalenas', nombre: 'Magdalenas con Glaseado Rosa', imagen: 'magdalenas.png' }, { id: 'berenjena', nombre: 'Berenjena Rellena', imagen: 'berenjena.png' }, { id: 'coctel', nombre: 'Cóctel Dulce', imagen: 'Coctel.png' }, { id: 'trago_afrutado', nombre: 'Trago Afrutado', imagen: 'trago afrutado.png' }, { id: 'almejas', nombre: 'Almejas Picantes', imagen: 'almejas.png' }];
        
        // *** VARIABLES GLOBALES - AHORA SERÁN POBLADAS DESDE FIRESTORE ***
        let empleados = [];
        let fichajes = {};
        let ventas = {};
        let habitaciones = [];
        let anuncios = [];
        let libroNegro = [];
        let listaNegra = [];

        let fichajeInterval = null, habitacionesInterval = null, dashboardInterval = null;

        // ===================================================================================
        //  2. FUNCIONES GLOBALES Y AUXILIARES
        // ===================================================================================
        // Se asignan a 'window' para que los 'onclick' del HTML puedan encontrarlas.
        
        window.hashPassword = (str) => { let hash = 0; if (typeof str !== 'string' || str.length === 0) return "hash_0"; for (let i = 0; i < str.length; i++) { const char = str.charCodeAt(i); hash = ((hash << 5) - hash) + char; hash |= 0; } return "hash_" + Math.abs(hash); }
        
        // *** LAS FUNCIONES cargarDatos y guardarDatos DE localStorage YA NO SE USAN EN GENERAL ***
        // *** SOLO SE MANTIENEN EN ESTE CÓDIGO POR SI HAY ALGUNA REFERENCIA ANTIGUA EN SECCIONES NO MIGRADA AÚN ***
        window.cargarDatos = (clave, valorPorDefecto, storage = localStorage) => { const datosGuardados = storage.getItem(clave); if (!datosGuardados) return valorPorDefecto; try { const datosParseados = JSON.parse(datosGuardados); return (typeof datosParseados === 'object' && datosParseados !== null) ? datosParseados : valorPorDefecto; } catch (e) { return valorPorDefecto; } }
        window.guardarDatos = (clave, datos, storage = localStorage) => { storage.setItem(clave, JSON.stringify(datos)); }
        
        window.formatearTiempo = (ms) => { if (isNaN(ms) || ms < 0) ms = 0; const totalSegundos = Math.floor(ms / 1000); const horas = String(Math.floor(totalSegundos / 3600)).padStart(2, '0'); const minutos = String(Math.floor((totalSegundos % 3600) / 60)).padStart(2, '0'); const segundos = String(totalSegundos % 60).padStart(2, '0'); return `${horas}:${minutos}:${segundos}`; }
        window.getEstadoHabitacion = (hab) => { const ahora = Date.now(); if (!hab || !hab.reservas) return { estado: 'disponible', texto: 'Disponible', reservaActual: null }; const reservaActual = hab.reservas.find(r => ahora >= r.inicio && ahora < r.fin); if (reservaActual) { return { estado: 'ocupada', texto: 'Ocupada', reservaActual }; } return { estado: 'disponible', texto: 'Disponible', reservaActual: null }; }
        window.getWeekNumber = (d) => { d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7)); var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1)); return Math.ceil((((d - yearStart) / 86400000) + 1)/7); }
        
        // *** gestionarReseteoDatos AHORA TAMBIÉN INTERACTÚA CON FIRESTORE ***
        window.gestionarReseteoDatos = async (nombre, esVenta = false) => {
            const ahora = new Date();
            const anio = ahora.getFullYear();
            const mes = String(ahora.getMonth() + 1).padStart(2, '0');
            const dia = String(ahora.getDate()).padStart(2, '0');
            const hoyStr = `${anio}-${mes}-${dia}`;
            const semanaNum = getWeekNumber(ahora);

            if (esVenta) {
                // Lógica para ventas
                let datosVentaDoc = await getDoc(doc(db, 'ventas', nombre));
                let datosV = datosVentaDoc.exists() ? datosVentaDoc.data() : { productos: {}, fecha: '' };

                if (typeof datosV !== 'object' || Array.isArray(datosV)) datosV = { productos: {}, fecha: '' };
                if (!datosV.productos) datosV.productos = {};

                if (datosV.fecha !== hoyStr) {
                    datosV.fecha = hoyStr;
                    Object.keys(datosV.productos).forEach(key => {
                        datosV.productos[key].hoy = 0;
                    });
                }
                ventas[nombre] = datosV; // Actualiza la variable global 'ventas'
                return datosV;
            } else {
                // Lógica para fichajes
                let datosFichajeDoc = await getDoc(doc(db, 'fichajes', nombre));
                let datosF = datosFichajeDoc.exists() ? datosFichajeDoc.data() : null;

                if (!datosF || typeof datosF.total !== 'number') { // Si no existe o está mal, inicializa
                    datosF = { total: 0, hoy: 0, semana: 0, fecha: hoyStr, numSemana: semanaNum, fichado: false, inicio: null };
                }
                
                if (datosF.fecha !== hoyStr) {
                    datosF.hoy = 0;
                    datosF.fecha = hoyStr;
                }
                if (datosF.numSemana !== semanaNum) {
                    datosF.semana = 0;
                    datosF.numSemana = semanaNum;
                }
                fichajes[nombre] = datosF; // Actualiza la variable global 'fichajes'
                // No guardamos aquí, solo gestionamos el estado local. El guardado se hará en fichar/desfichar.
                return datosF;
            }
        }
        window.crearTarjetaProducto = (producto, esPanelVenta = false, nombreEmpleado = '') => { 
            let totalVentasHoy = 0;
            let totalVentasHist = 0;
            if (ventas[nombreEmpleado] && ventas[nombreEmpleado].productos && ventas[nombreEmpleado].productos[producto.id]) {
                totalVentasHoy = ventas[nombreEmpleado].productos[producto.id].hoy || 0;
                totalVentasHist = ventas[nombreEmpleado].productos[producto.id].total || 0;
            }
            const desc = `Hoy: ${totalVentasHoy} | Total: ${totalVentasHist}`;
            const inputVentasHTML = esPanelVenta ? `<div class="mt-2"><input type="number" min="0" value="0" id="input-${producto.id}" class="w-20 px-2 py-1 text-black rounded" onchange="actualizarVentas('${producto.id}', '${nombreEmpleado}')" /><p class="text-xs mt-1">${desc}</p></div>` : `<p class="text-purple-300 text-sm mt-2">${producto.descripcion || ''}</p>`; 
            return `<div class="producto-card bg-purple-800 rounded-lg p-2 text-center shadow-md flex flex-col justify-between text-sm"><div><img src="${producto.imagen}" alt="${producto.nombre}" class="mx-auto mb-2 w-20 h-20 object-cover rounded" /><h3 class="text-white font-semibold leading-tight">${producto.nombre}</h3></div><div>${inputVentasHTML}</div></div>`; 
        }

        // *** NUEVA FUNCIÓN para actualizar ventas en Firestore ***
        window.actualizarVentas = async (productoId, nombreEmpleado) => {
            const cantidadInput = document.getElementById(`input-${productoId}`);
            const cantidad = parseInt(cantidadInput.value);

            if (isNaN(cantidad) || cantidad < 0) {
                alert("Por favor, introduce una cantidad válida.");
                cantidadInput.value = '0';
                return;
            }

            try {
                // Asegurar que el objeto de ventas para el empleado existe
                let datosVenta = ventas[nombreEmpleado] || { productos: {}, fecha: '' };
                if (!datosVenta.productos[productoId]) {
                    datosVenta.productos[productoId] = { hoy: 0, total: 0 };
                }

                // Actualizar las ventas en el objeto local (se sumará a lo que ya tenga)
                datosVenta.productos[productoId].hoy += cantidad;
                datosVenta.productos[productoId].total += cantidad;
                datosVenta.fecha = new Date().toISOString().split('T')[0]; // Asegurar que la fecha es la de hoy

                ventas[nombreEmpleado] = datosVenta; // Actualiza la variable global

                // Guardar en Firestore
                await setDoc(doc(db, 'ventas', nombreEmpleado), datosVenta);
                
                alert(`Venta(s) de ${cantidad} ${productos.find(p => p.id === productoId).nombre} registrada(s) para ${nombreEmpleado}.`);
                cantidadInput.value = '0'; // Resetear el input después de registrar
                mostrarPanelEmpleados(nombreEmpleado); // Refrescar el panel para ver los totales actualizados
            } catch (e) {
                console.error("Error al actualizar ventas en Firestore:", e);
                alert("Error al registrar la venta. Por favor, inténtalo de nuevo.");
            }
        };

        const iniciarRelojFichaje = (horaInicio, baseHoy, baseSemana, baseTotal) => { detenerRelojFichaje(); fichajeInterval = setInterval(() => { const tiempoSesion = Date.now() - horaInicio; document.getElementById('tiempoHoy').textContent = formatearTiempo(baseHoy + tiempoSesion); document.getElementById('tiempoSemana').textContent = formatearTiempo(baseSemana + tiempoSesion); document.getElementById('tiempoTotal').textContent = formatearTiempo(baseTotal + tiempoSesion); document.getElementById('tiempoSesion').textContent = formatearTiempo(tiempoSesion); }, 1000); }
        const detenerRelojFichaje = () => { if (fichajeInterval) { clearInterval(fichajeInterval); fichajeInterval = null; } }
        const iniciarRelojHabitaciones = () => { detenerRelojHabitaciones(); habitacionesInterval = setInterval(() => { habitaciones.forEach(hab => { const estadoActual = getEstadoHabitacion(hab); let tiempoRestanteElem = document.getElementById(`timer-hab-${hab.id}`); if (tiempoRestanteElem) { if (estadoActual.estado === 'ocupada') { const restante = estadoActual.reservaActual.fin - Date.now(); if (restante > 0) { tiempoRestanteElem.textContent = formatearTiempo(restante); } else { tiempoRestanteElem.textContent = "¡TIEMPO AGOTADO!"; tiempoRestanteElem.classList.add('text-red-500'); } } else { // Si la habitación ya no está ocupada, limpia el temporizador
                        tiempoRestanteElem.textContent = "--:--:--";
                        tiempoRestanteElem.classList.remove('text-red-500');
                    }
                }
            });
        }, 1000); }
        const detenerRelojHabitaciones = () => { if(habitacionesInterval) { clearInterval(habitacionesInterval); habitacionesInterval = null; } }
        const iniciarDashboard = () => { detenerDashboard(); dashboardInterval = setInterval(actualizarDashboard, 5000); }
        const detenerDashboard = () => { if(dashboardInterval) { clearInterval(dashboardInterval); dashboardInterval = null; } }
        
        // El resto de funciones se asignan a window para ser accesibles desde el HTML
        window.mostrarInicio = () => { detenerRelojFichaje(); detenerRelojHabitaciones(); detenerDashboard(); document.getElementById('contenido').innerHTML = `<div class="p-4 md:p-8 max-w-7xl mx-auto rounded-lg bg-purple-900 bg-opacity-90 shadow-lg"><header class="mb-8 text-center"><h1 class="text-5xl font-extrabold text-white drop-shadow-lg mb-2">Bienvenido a Moore Club</h1><p class="text-purple-300 text-lg">Donde la tentación y la elegancia se encuentran.</p></header><div class="flex flex-col md:flex-row items-center gap-8"><div class="md:w-5/12"><img src="Tito y Marta.png" alt="Tito y Marta" class="rounded-lg shadow-2xl w-full h-auto object-cover" /></div><div class="md:w-7/12 space-y-6"><div class="bg-purple-800 bg-opacity-50 p-4 rounded-lg"><h2 class="text-2xl font-bold text-white mb-2">Tito Giovanni</h2><p class="text-purple-200">El carismático maestro de ceremonias y corazón de Moore. Su elegancia y estilo inconfundible, siempre vestido de morado, garantizan una noche inolvidable. Es el anfitrión perfecto, el alma de la fiesta.</p></div><div class="bg-purple-800 bg-opacity-50 p-4 rounded-lg"><h2 class="text-2xl font-bold text-white mb-2">Marta</h2><p class="text-purple-200">La musa indiscutible del club. Con una actitud que cautiva y una sensualidad que desarma, Marta es la protagonista de los shows más aclamados. Su presencia en el escenario es pura magia y provocación.</p></div></div></div><div class="mt-10 flex justify-center gap-4"><button onclick="mostrarLoginVIP()" class="btn">Área Empleados</button><button onclick="mostrarLoginAdmin()" class="btn" style="background-color: #a855f7;">Tito Giovanni</button></div></div>`; }
        
        // *** mostrarPanelEmpleados - AHORA MÁS ASÍNCRONA ***
        window.mostrarPanelEmpleados = async (nombre) => { // *** AÑADIDO 'async' ***
            detenerDashboard();
            detenerRelojHabitaciones();
            
            // Cargar datos de fichaje y ventas para el empleado actual desde Firestore
            const datosFichaje = await gestionarReseteoDatos(nombre); // gestiona y actualiza 'fichajes' globalmente
            await gestionarReseteoDatos(nombre, true); // gestiona y actualiza 'ventas' globalmente

            let tiempoHoy = datosFichaje.hoy, tiempoSemana = datosFichaje.semana, tiempoTotal = datosFichaje.total;
            if (datosFichaje.fichado) {
                const tiempoDesdeFichaje = Date.now() - datosFichaje.inicio;
                tiempoHoy += tiempoDesdeFichaje;
                tiempoSemana += tiempoDesdeFichaje;
                tiempoTotal += tiempoDesdeFichaje;
            }

            const productosVentaHTML = productos.map(p => crearTarjetaProducto(p, true, nombre)).join('');
            
            let habitacionesHTML = '';
            // Asegúrate de que 'habitaciones' global está poblada antes de usarla
            if (habitaciones.length === 0) { // Si por alguna razón no se cargaron al inicio
                 await cargarTodasLasHabitaciones();
            }
            habitaciones.forEach(hab => {
                const estadoActual = getEstadoHabitacion(hab);
                let controles = '';
                if (estadoActual.estado === 'disponible') {
                    controles = `<button class="btn text-sm py-2 w-full" onclick="ocuparHabitacionAhora(${hab.id}, '${nombre}')">Ocupar (30 min)</button>`;
                } else {
                    controles = `<div class="font-mono text-xl mb-2" id="timer-hab-${hab.id}">--:--:--</div><div class="flex gap-2"><button class="btn text-xs py-1 flex-grow" onclick="anadirTiempoHabitacion(${hab.id}, '${nombre}')">+30 min</button><button class="btn text-xs py-1 flex-grow" style="background-color:#c44" onclick="liberarHabitacion(${hab.id}, '${nombre}')">Liberar</button></div>`;
                }
                habitacionesHTML += `<div class="bg-purple-800 p-4 rounded-lg text-center flex flex-col justify-between"><div><p class="font-bold text-lg">${hab.nombre}</p><p class="text-sm ${estadoActual.estado === 'ocupada' ? 'text-red-400' : 'text-green-400'} mb-2">${estadoActual.texto}</p></div><div>${controles}</div></div>`;
            });

            // Revisa si hay nuevos anuncios (ahora desde Firestore)
            const hayNotificaciones = await comprobarNuevosAnuncios(nombre);
            const notificacionHTML = `<div class="relative"><button onclick="mostrarAnuncios('${nombre}')" class="text-2xl">🔔</button>${hayNotificaciones ? '<div class="notification-dot"></div>' : ''}</div>`;
            
            const listaNegraBtn = `<button onclick="mostrarListaNegraPublica()" class="btn text-xs py-1">Ver Vetados</button>`;
            
            document.getElementById('contenido').innerHTML = `<div class="p-6 bg-purple-900 bg-opacity-90 rounded-lg max-w-6xl mx-auto shadow-lg"><div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold">Panel de Fichaje: <span class="text-purple-300 capitalize">${nombre}</span></h2><div class="flex items-center gap-4">${listaNegraBtn}${notificacionHTML}<button class="btn" style="background-color: #d63636;" onclick="cerrarSesion()">Cerrar Sesión</button></div></div><div class="bg-purple-800 p-4 rounded-lg mb-6 grid grid-cols-1 md:grid-cols-4 gap-4 text-center items-center"><div><p class="text-sm text-purple-300">TIEMPO HOY</p><p id="tiempoHoy" class="font-mono text-xl">${formatearTiempo(tiempoHoy)}</p></div><div><p class="text-sm text-purple-300">TIEMPO SEMANA</p><p id="tiempoSemana" class="font-mono text-xl">${formatearTiempo(tiempoSemana)}</p></div><div><p class="text-sm text-purple-300">TIEMPO TOTAL</p><p id="tiempoTotal" class="font-mono text-xl">${formatearTiempo(tiempoTotal)}</p></div><div class="bg-purple-700 p-2 rounded-lg"><p class="text-sm text-purple-200">SESIÓN ACTUAL</p><p id="tiempoSesion" class="font-mono text-xl font-bold text-white">00:00:00</p></div></div><div class="text-center mb-8"><button class="btn text-lg px-6 py-3" onclick="fichar('${nombre}')">Fichar Entrada</button><button class="btn text-lg px-6 py-3" onclick="desfichar('${nombre}')">Fichar Salida</button></div> <h3 class="text-xl font-semibold mb-4 border-t border-purple-700 pt-6">Gestión de Habitaciones</h3><div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-8">${habitacionesHTML}</div> <h3 class="text-xl font-semibold mb-4 border-t border-purple-700 pt-6">Registrar Ventas</h3><div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4" id="productosVenta">${productosVentaHTML}</div></div>`;
            iniciarRelojHabitaciones();
        }

        window.mostrarPanelProductos = () => { detenerRelojFichaje(); detenerRelojHabitaciones(); detenerDashboard(); document.getElementById('contenido').innerHTML = `<h2 class="text-2xl font-bold mb-6 text-center">Productos Moore Club</h2><div class="grid grid-cols-2 md:grid-cols-4 gap-6">${productos.map(p => crearTarjetaProducto(p, false)).join('')}</div><div class="text-center"><button onclick="mostrarInicio()" class="btn mt-8">Volver</button></div>`; }
        
        // *** mostrarPanelHabitaciones - AHORA ASÍNCRONA ***
        window.mostrarPanelHabitaciones = async () => { // *** AÑADIDO 'async' ***
            detenerRelojFichaje();
            detenerRelojHabitaciones();
            detenerDashboard();

            // Asegúrate de tener las habitaciones cargadas
            if (habitaciones.length === 0) {
                await cargarTodasLasHabitaciones();
            }

            let html = `<div class="max-w-7xl mx-auto text-center"><h1 class="text-4xl font-bold mb-8">Nuestras Habitaciones</h1><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">`;
            habitaciones.forEach(hab => {
                const estadoActual = getEstadoHabitacion(hab);
                html += `<div class="border-2 ${estadoActual.estado === 'disponible' ? 'border-purple-600' : 'border-gray-600'} p-4 rounded-lg bg-purple-900 bg-opacity-50 flex flex-col"><div class="flex-grow flex gap-4"><div class="w-1/3 bg-black/20 rounded"></div><div class="w-2/3 text-left"><h2 class="text-2xl font-bold">${hab.nombre}</h2><p class="text-lg ${estadoActual.estado === 'disponible' ? 'text-green-400' : 'text-red-400'}">${estadoActual.texto}</p><div class="mt-2 text-sm"><p class="font-bold mb-1">Reservas para hoy:</p><ul class="list-disc list-inside space-y-1 h-20 overflow-y-auto text-xs">${hab.reservas.filter(r => new Date(r.inicio).toDateString() === new Date().toDateString()).sort((a,b)=>a.inicio-b.inicio).map(r => `<li>${new Date(r.inicio).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})} - ${new Date(r.fin).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})} (${r.cliente})</li>`).join('') || '<li>Ninguna reserva hoy.</li>'}</ul></div></div></div><div id="form-hab-${hab.id}" class="mt-3 text-left border-t border-purple-800 pt-3"><h4 class="font-bold mb-2 text-center">Hacer una nueva reserva:</h4><input type="text" id="cliente-hab-${hab.id}" placeholder="Tu nombre" class="w-full p-2 rounded bg-gray-800 text-white mb-2 text-sm"><div class="flex gap-2"><input type="date" id="fecha-hab-${hab.id}" class="w-full p-2 rounded bg-gray-800 text-white mb-2 text-sm"><input type="time" id="hora-hab-${hab.id}" step="1800" class="w-full p-2 rounded bg-gray-800 text-white mb-2 text-sm"></div><select id="duracion-hab-${hab.id}" class="w-full p-2 rounded bg-gray-800 text-white mb-2 text-sm"><option value="1">1 Hora</option><option value="2">2 Horas</option><option value="3">3 Horas</option></select><button class="btn w-full mt-2" onclick="reservarHabitacion(${hab.id})">Confirmar Reserva</button></div></div>`;
            });
            html += `</div></div>`;
            document.getElementById('contenido').innerHTML = html;
            const hoy = new Date();
            const unaSemana = new Date(hoy);
            unaSemana.setDate(hoy.getDate() + 7);
            const minDate = hoy.toISOString().split('T')[0];
            const maxDate = unaSemana.toISOString().split('T')[0];
            document.querySelectorAll('input[type="date"]').forEach(input => {
                input.min = minDate;
                input.max = maxDate;
                input.value = minDate;
            });
        }
        window.mostrarLoginVIP = () => { detenerRelojFichaje(); detenerRelojHabitaciones(); detenerDashboard(); document.getElementById('contenido').innerHTML = `<div class="max-w-md mx-auto bg-black bg-opacity-30 p-8 rounded-lg shadow-lg"><h2 class="text-2xl font-bold mb-4 text-center">Acceso Empleados</h2><div class="mb-4"><label class="block mb-2">Nombre completo:</label><input id="nombreInput" type="text" class="w-full px-3 py-2 text-black rounded" placeholder="nombre y apellido en minúsculas" /></div><div class="mb-4"><label class="block mb-2">Contraseña:</label><input id="passInput" type="password" class="w-full px-3 py-2 text-black rounded" /></div><div class="flex justify-between mt-6"><button onclick="verificarAccesoVIP()" class="btn">Entrar</button><button onclick="mostrarInicio()" class="btn" style="background-color:#5b189b;">Volver</button></div></div>`; }
        window.mostrarLoginAdmin = () => { detenerRelojFichaje(); detenerRelojHabitaciones(); detenerDashboard(); document.getElementById('contenido').innerHTML = `<div class="max-w-md mx-auto bg-black bg-opacity-50 p-8 rounded-lg shadow-lg border-2 border-purple-400"><h2 class="text-3xl font-bold mb-4 text-center text-purple-300">Acceso Privado - Tito Giovanni</h2><label class="block mb-2">Contraseña de Administrador:</label><input id="adminPassInput" type="password" class="w-full px-3 py-2 text-black rounded" /><div class="flex justify-between"><button onclick="verificarAccesoAdmin()" class="btn">Entrar</button><button onclick="mostrarInicio()" class="btn" style="background-color:#5b189b;">Volver</button></div></div>`; }
        
        // *** mostrarPanelAdmin - AHORA MÁS ASÍNCRONA ***
        window.mostrarPanelAdmin = async () => { // *** AÑADIDO 'async' ***
            detenerRelojFichaje();
            detenerRelojHabitaciones();
            detenerDashboard();

            // Asegurarse de tener los datos más recientes
            await cargarTodosLosEmpleados(); // Recarga 'empleados'
            await cargarTodosLosFichajes(); // Recarga 'fichajes'
            await cargarTodasLasVentas(); // Recarga 'ventas'
            await cargarTodosLosAnuncios(); // Recarga 'anuncios'
            await cargarLibroNegro(); // Recarga 'libroNegro'
            await cargarListaNegra(); // Recarga 'listaNegra'

            const dashboardHTML = `<div class="mb-8 p-6 bg-purple-900 bg-opacity-50 rounded-lg"><h2 class="text-2xl font-bold mb-4">Dashboard en Tiempo Real</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><h3 class="font-semibold mb-2">Empleados Activos</h3><ul id="dashboard-empleados" class="space-y-1 text-sm"></ul></div><div><h3 class="font-semibold mb-2">Habitaciones Ocupadas</h3><ul id="dashboard-habitaciones" class="space-y-1 text-sm"></ul></div></div></div>`;
            const anunciosHTML = `<div class="mb-8 p-6 bg-purple-900 bg-opacity-50 rounded-lg"><h2 class="text-2xl font-bold mb-4">Publicar Anuncio Global</h2><textarea id="anuncioTexto" class="w-full p-2 text-black rounded mb-2" rows="3" placeholder="Escribe tu anuncio aquí..."></textarea><button onclick="publicarAnuncio()" class="btn">Publicar</button></div>`;
            
            let tablaEmpleadosHTML = '';
            empleados.forEach(empleado => {
                // Hay que llamar a gestionarReseteoDatos (que es async) para cada empleado,
                // pero eso complica el forEach síncrono.
                // Para el panel de admin, la información de fichaje y ventas ya debería estar actualizada en 'fichajes' y 'ventas' globales.
                const datosFichaje = fichajes[empleado.nombre] || { hoy: 0, semana: 0, total: 0 };
                const datosVentas = ventas[empleado.nombre] || { productos: {} };

                let ventasHoy = 0;
                let ventasTotal = 0;
                if (datosVentas && datosVentas.productos) {
                    for (const prodId in datosVentas.productos) {
                        ventasHoy += datosVentas.productos[prodId].hoy || 0;
                        ventasTotal += datosVentas.productos[prodId].total || 0;
                    }
                }
                tablaEmpleadosHTML += `<tr class="border-b border-purple-800 hover:bg-purple-900"><td class="p-3 capitalize">${empleado.nombre}</td><td class="p-3 font-mono">${formatearTiempo(datosFichaje.hoy)}</td><td class="p-3 font-mono">${formatearTiempo(datosFichaje.semana)}</td><td class="p-3 font-mono">${formatearTiempo(datosFichaje.total)}</td><td class="p-3 font-mono text-center">${ventasHoy}</td><td class="p-3 font-mono text-center">${ventasTotal}</td><td class="p-3 text-center"><button onclick="cambiarContrasena('${empleado.nombre}')" class="btn text-xs py-1">Cambiar Pass</button><button onclick="eliminarEmpleado('${empleado.nombre}')" class="text-red-500 hover:text-red-400 font-bold text-lg ml-2">X</button></td></tr>`;
            });
            
            const gestionHTML = `<div class="mb-8 p-6 bg-purple-900 bg-opacity-50 rounded-lg"><h2 class="text-2xl font-bold mb-4">Gestionar Empleados</h2><div class="flex flex-col md:flex-row gap-4"><input type="text" id="newEmployeeName" class="flex-grow px-3 py-2 text-black rounded" placeholder="Nombre y apellido..."><input type="password" id="newEmployeePass" class="flex-grow px-3 py-2 text-black rounded" placeholder="Contraseña..."><button onclick="anadirEmpleado()" class="btn">Añadir Empleado</button></div></div>`;
            const tablaHTML = `<div class="overflow-x-auto bg-purple-900 bg-opacity-80 rounded-lg shadow-xl"><table class="w-full text-left"><thead class="bg-purple-800 text-purple-200 uppercase text-sm"><tr><th class="p-3">Empleado</th><th class="p-3">Horas Hoy</th><th class="p-3">Horas Semana</th><th class="p-3">Horas Total</th><th class="p-3 text-center">Ventas Hoy (uds.)</th><th class="p-3 text-center">Ventas Total (uds.)</th><th class="p-3 text-center">Acciones</th></tr></thead><tbody>${tablaEmpleadosHTML}</tbody></table></div>`;
            
            // Renderizar Libro Negro y Lista Negra usando las funciones actualizadas
            const libroNegroHTML = `<div class="mb-8 p-6 bg-purple-900 bg-opacity-50 rounded-lg"><h2 class="text-2xl font-bold mb-4">Libro Negro de Contactos</h2><div class="flex flex-col md:flex-row gap-4 mb-4"><input type="text" id="libroNombre" class="flex-grow px-3 py-2 text-black rounded" placeholder="Nombre del contacto..."><select id="libroRelacion" class="px-3 py-2 text-black rounded"><option value="Aliado">Aliado</option><option value="Rival">Rival</option><option value="Neutral">Neutral</option></select><input type="text" id="libroNotas" class="flex-grow px-3 py-2 text-black rounded" placeholder="Notas..."><button onclick="anadirAlLibroNegro()" class="btn">Añadir</button></div><ul id="listaLibroNegro" class="space-y-2"></ul></div>`;
            const listaNegraHTML = `<div class="mb-8 p-6 bg-purple-900 bg-opacity-50 rounded-lg"><h2 class="text-2xl font-bold mb-4">Lista Negra (Personas Vetadas)</h2><div class="flex flex-col md:flex-row gap-4 mb-4"><input type="text" id="vetadoNombre" class="flex-grow px-3 py-2 text-black rounded" placeholder="Nombre de la persona..."><input type="text" id="vetadoMotivo" class="flex-grow px-3 py-2 text-black rounded" placeholder="Motivo del veto..."><button onclick="anadirAListaNegra()" class="btn">Vetar</button></div><ul id="listaDeVetados" class="space-y-2"></ul></div>`;
            
            document.getElementById('contenido').innerHTML = `<div class="max-w-7xl mx-auto"><h1 class="text-4xl font-bold text-center mb-8">Panel de Administración</h1>${dashboardHTML}${anunciosHTML}${gestionHTML}${tablaHTML}${libroNegroHTML}${listaNegraHTML}<div class="text-center mt-8"><button onclick="mostrarInicio()" class="btn">Volver a Inicio</button></div></div>`;
            
            actualizarDashboard();
            iniciarDashboard();
            // Llama a estas después de renderizar el HTML para que los IDs existan
            actualizarLibroNegro(); 
            actualizarListaNegra();
        }

        const actualizarDashboard = () => {
            const empleadosActivosElem = document.getElementById('dashboard-empleados');
            const habitacionesOcupadasElem = document.getElementById('dashboard-habitaciones');
            if (!empleadosActivosElem || !habitacionesOcupadasElem) return;

            empleadosActivosElem.innerHTML = '';
            // Iterar sobre el objeto global 'fichajes'
            Object.keys(fichajes).forEach(nombre => {
                if (fichajes[nombre].fichado) {
                    const tiempoSesion = formatearTiempo(Date.now() - fichajes[nombre].inicio);
                    empleadosActivosElem.innerHTML += `<li class="capitalize">${nombre} (Sesión: ${tiempoSesion})</li>`;
                }
            });
            if (empleadosActivosElem.innerHTML === '') empleadosActivosElem.innerHTML = '<li>Ningún empleado fichado.</li>';

            habitacionesOcupadasElem.innerHTML = '';
            habitaciones.forEach(hab => {
                const estado = getEstadoHabitacion(hab);
                if (estado.estado === 'ocupada') {
                    const tiempoRestante = formatearTiempo(estado.reservaActual.fin - Date.now());
                    habitacionesOcupadasElem.innerHTML += `<li>${hab.nombre} (${estado.reservaActual.cliente}) - Restante: ${tiempoRestante}</li>`;
                }
            });
            if (habitacionesOcupadasElem.innerHTML === '') habitacionesOcupadasElem.innerHTML = '<li>Ninguna habitación ocupada.</li>';
        }
        
        // *** verificarAccesoAdmin - AHORA ASÍNCRONA Y DISPARA CARGA DE DATOS ***
        window.verificarAccesoAdmin = async () => { // *** MANTENER 'async' ***
            const adminPassInput = document.getElementById('adminPassInput');
            if (adminPassInput?.value === "D.VaSong11") {
                // Antes de mostrar el panel, nos aseguramos de que todos los datos estén cargados
                await cargarTodosLosEmpleados();
                await cargarTodosLosFichajes();
                await cargarTodasLasVentas();
                await cargarTodasLasHabitaciones();
                await cargarTodosLosAnuncios();
                await cargarLibroNegro();
                await cargarListaNegra();
                mostrarPanelAdmin();
            } else {
                alert('Contraseña incorrecta.');
            }
        }

        // *** verificarAccesoVIP - AHORA ASÍNCRONA ***
        window.verificarAccesoVIP = async () => { // *** MANTENER 'async' ***
            const nombre = document.getElementById('nombreInput')?.value.trim().toLowerCase();
            const pass = document.getElementById('passInput')?.value;
            
            // Cargar el empleado específico de Firestore
            const empleadoDoc = await getDoc(doc(db, 'empleados', nombre)); // 'empleados' es el nombre de la colección
            const empleado = empleadoDoc.exists() ? empleadoDoc.data() : null;

            if (empleado && hashPassword(pass) === empleado.passHash) {
                sessionStorage.setItem('currentUser', nombre); // Esto aún usa sessionStorage, que está bien para la sesión actual
                // Cargar los datos del empleado específico para mostrar su panel
                await gestionarReseteoDatos(nombre); // Fichajes
                await gestionarReseteoDatos(nombre, true); // Ventas
                mostrarPanelEmpleados(nombre);
                const datosFichaje = fichajes[nombre];
                if (datosFichaje && datosFichaje.fichado) {
                    iniciarRelojFichaje(datosFichaje.inicio, datosFichaje.hoy, datosFichaje.semana, datosFichaje.total);
                }
            } else {
                alert('Nombre de usuario o contraseña incorrectos.');
            }
        }

        // *** anadirEmpleado - AHORA ASÍNCRONA ***
        window.anadirEmpleado = async () => { // *** MANTENER 'async' ***
            const inputNombre = document.getElementById('newEmployeeName');
            const inputPass = document.getElementById('newEmployeePass');
            const nombre = inputNombre.value.trim().toLowerCase();
            const pass = inputPass.value;

            if (!nombre || !pass) {
                alert('El nombre y la contraseña son obligatorios.');
                return;
            }
            
            // Verificar si el empleado ya existe en Firestore
            const empleadoExistente = await getDoc(doc(db, 'empleados', nombre));
            if (empleadoExistente.exists()) {
                alert('Este empleado ya existe.');
                return;
            }

            // Añadir el nuevo empleado a Firestore
            const nuevoEmpleado = { nombre: nombre, passHash: hashPassword(pass), ultimoAnuncioVisto: 0 };
            try {
                await setDoc(doc(db, 'empleados', nombre), nuevoEmpleado); // Guarda usando el nombre como ID del documento
                empleados.push(nuevoEmpleado); // Añade al array local para actualizar la vista
                // Inicializar fichajes y ventas para el nuevo empleado en las colecciones globales
                fichajes[nombre] = { total: 0, hoy: 0, semana: 0, fecha: new Date().toISOString().split('T')[0], numSemana: getWeekNumber(new Date()), fichado: false, inicio: null };
                ventas[nombre] = { productos: {}, fecha: '' };
                alert(`Empleado ${nombre} añadido con éxito.`);
                mostrarPanelAdmin(); // Vuelve a mostrar el panel para refrescar la lista
            } catch (e) {
                console.error("Error al añadir empleado a Firestore:", e);
                alert("Error al añadir el empleado. Por favor, inténtalo de nuevo.");
            }
        }
        
        // *** cambiarContrasena - AHORA ASÍNCRONA ***
        window.cambiarContrasena = async (nombre) => { // *** MANTENER 'async' ***
            const nuevaPass = prompt(`Introduce la nueva contraseña para ${nombre}:`);
            if (nuevaPass) {
                try {
                    const empleadoRef = doc(db, 'empleados', nombre);
                    await updateDoc(empleadoRef, { passHash: hashPassword(nuevaPass) });
                    // Actualiza también el array local 'empleados' para reflejar el cambio
                    const empleadoLocal = empleados.find(e => e.nombre === nombre);
                    if (empleadoLocal) {
                        empleadoLocal.passHash = hashPassword(nuevaPass);
                    }
                    alert(`Contraseña de ${nombre} actualizada.`);
                    mostrarPanelAdmin();
                } catch (e) {
                    console.error("Error al cambiar contraseña en Firestore:", e);
                    alert("Error al cambiar la contraseña. Por favor, inténtalo de nuevo.");
                }
            }
        }

        // *** eliminarEmpleado - AHORA ASÍNCRONA ***
        window.eliminarEmpleado = async (nombre) => { // *** MANTENER 'async' ***
            if (nombre === 'tito giovanni') {
                alert('No se puede eliminar al administrador principal.');
                return;
            }
            if (confirm(`¿Estás seguro de que quieres eliminar a ${nombre}?\nEsta acción es permanente y borrará todos sus datos de empleados, fichajes y ventas.`)) {
                try {
                    // Eliminar de la colección 'empleados'
                    await deleteDoc(doc(db, 'empleados', nombre));
                    // Eliminar de la colección 'fichajes'
                    await deleteDoc(doc(db, 'fichajes', nombre));
                    // Eliminar de la colección 'ventas'
                    await deleteDoc(doc(db, 'ventas', nombre));

                    // Actualizar variables locales
                    empleados = empleados.filter(e => e.nombre !== nombre);
                    delete fichajes[nombre];
                    delete ventas[nombre];

                    alert(`Empleado ${nombre} y sus datos asociados eliminados.`);
                    mostrarPanelAdmin();
                } catch (e) {
                    console.error("Error al eliminar empleado de Firestore:", e);
                    alert("Error al eliminar el empleado. Por favor, inténtalo de nuevo.");
                }
            }
        }

        // *** fichar - AHORA ASÍNCRONA ***
        window.fichar = async (nombre) => { // *** AÑADIDO 'async' ***
            let datosFichaje = await gestionarReseteoDatos(nombre); // Asegura que los datos locales están al día

            if (!datosFichaje.fichado) {
                datosFichaje.fichado = true;
                datosFichaje.inicio = Date.now();
                fichajes[nombre] = datosFichaje; // Actualiza la variable global

                try {
                    await setDoc(doc(db, 'fichajes', nombre), datosFichaje); // Guarda en Firestore
                    mostrarPanelEmpleados(nombre);
                    iniciarRelojFichaje(datosFichaje.inicio, datosFichaje.hoy, datosFichaje.semana, datosFichaje.total);
                } catch (e) {
                    console.error("Error al fichar entrada en Firestore:", e);
                    alert("Error al registrar la entrada. Intenta de nuevo.");
                }
            }
        }

        // *** desfichar - AHORA ASÍNCRONA ***
        window.desfichar = async (nombre) => { // *** AÑADIDO 'async' ***
            detenerRelojFichaje();
            let datosFichaje = await gestionarReseteoDatos(nombre); // Asegura que los datos locales están al día

            if (datosFichaje.fichado) {
                const tiempoTrabajado = Date.now() - datosFichaje.inicio;
                datosFichaje.hoy += tiempoTrabajado;
                datosFichaje.semana += tiempoTrabajado;
                datosFichaje.total += tiempoTrabajado;
                datosFichaje.fichado = false;
                datosFichaje.inicio = null;
                fichajes[nombre] = datosFichaje; // Actualiza la variable global

                try {
                    await setDoc(doc(db, 'fichajes', nombre), datosFichaje); // Guarda en Firestore
                    mostrarPanelEmpleados(nombre);
                } catch (e) {
                    console.error("Error al fichar salida en Firestore:", e);
                    alert("Error al registrar la salida. Intenta de nuevo.");
                }
            }
        }
        window.cerrarSesion = () => { detenerRelojFichaje(); detenerRelojHabitaciones(); detenerDashboard(); sessionStorage.removeItem('currentUser'); mostrarInicio(); }
        
        // *** reservarHabitacion - AHORA ASÍNCRONA ***
        window.reservarHabitacion = async (id) => { // *** AÑADIDO 'async' ***
            const hab = habitaciones.find(h => h.id === id);
            if (!hab) return;

            const cliente = document.getElementById(`cliente-hab-${id}`).value.trim();
            const fecha = document.getElementById(`fecha-hab-${id}`).value;
            const hora = document.getElementById(`hora-hab-${id}`).value;
            const duracion = parseInt(document.getElementById(`duracion-hab-${id}`).value);

            if (!cliente || !fecha || !hora || isNaN(duracion) || duracion <= 0) {
                alert("Por favor, rellena todos los campos y la duración.");
                return;
            }

            const [h, m] = hora.split(':');
            const inicioReserva = new Date(fecha);
            inicioReserva.setHours(parseInt(h), parseInt(m), 0, 0);
            const finReserva = new Date(inicioReserva.getTime() + duracion * 60 * 60 * 1000);

            // Verificar conflicto de horario
            const hayConflicto = hab.reservas.some(r => (inicioReserva.getTime() < r.fin) && (finReserva.getTime() > r.inicio));
            if (hayConflicto) {
                alert("Conflicto de horario. La habitación ya está reservada en ese tramo.");
                return;
            }

            // Añadir nueva reserva
            hab.reservas.push({ id: Date.now(), cliente: cliente, inicio: inicioReserva.getTime(), fin: finReserva.getTime() });
            
            try {
                // Guardar la habitación actualizada en Firestore
                await setDoc(doc(db, 'habitaciones', String(hab.id)), hab); // Usar String(hab.id) como ID del documento
                alert(`¡Reserva confirmada para ${cliente} en ${hab.nombre}!`);
                mostrarPanelHabitaciones(); // Refrescar el panel
            } catch (e) {
                console.error("Error al reservar habitación en Firestore:", e);
                alert("Error al confirmar la reserva. Por favor, inténtalo de nuevo.");
            }
        }
        
        // *** cancelarReserva - AHORA ASÍNCRONA ***
        window.cancelarReserva = async (habId, reservaId, nombreEmpleado) => { // *** AÑADIDO 'async' ***
            const hab = habitaciones.find(h => h.id === habId);
            if (!hab) return;

            const reservaIndex = hab.reservas.findIndex(r => r.id === reservaId);
            if (reservaIndex > -1) {
                if (confirm(`¿Seguro que quieres cancelar la reserva de '${hab.reservas[reservaIndex].cliente}'?`)) {
                    hab.reservas.splice(reservaIndex, 1); // Elimina del array local
                    try {
                        await setDoc(doc(db, 'habitaciones', String(hab.id)), hab); // Guarda en Firestore
                        alert("Reserva cancelada.");
                        mostrarPanelEmpleados(nombreEmpleado); // Refresca el panel
                    } catch (e) {
                        console.error("Error al cancelar reserva en Firestore:", e);
                        alert("Error al cancelar la reserva. Por favor, inténtalo de nuevo.");
                    }
                }
            }
        }
        
        // *** ocuparHabitacionAhora - AHORA ASÍNCRONA ***
        window.ocuparHabitacionAhora = async (id, nombreEmpleado) => { // *** AÑADIDO 'async' ***
            const hab = habitaciones.find(h => h.id === id);
            if (hab && getEstadoHabitacion(hab).estado === 'disponible') {
                const ahora = Date.now();
                const nuevaReserva = { id: ahora, cliente: 'Ocupación Directa', inicio: ahora, fin: ahora + 30 * 60 * 1000 };
                hab.reservas.push(nuevaReserva); // Añade al array local
                try {
                    await setDoc(doc(db, 'habitaciones', String(hab.id)), hab); // Guarda en Firestore
                    alert(`Habitación ${hab.nombre} ocupada directamente.`);
                    mostrarPanelEmpleados(nombreEmpleado); // Refresca el panel
                } catch (e) {
                    console.error("Error al ocupar habitación en Firestore:", e);
                    alert("Error al ocupar la habitación. Por favor, inténtalo de nuevo.");
                }
            }
        }

        // *** anadirTiempoHabitacion - AHORA ASÍNCRONA ***
        window.anadirTiempoHabitacion = async (id, nombreEmpleado) => { // *** AÑADIDO 'async' ***
            const hab = habitaciones.find(h => h.id === id);
            const ahora = Date.now();
            const reservaActual = hab.reservas.find(r => ahora >= r.inicio && ahora < r.fin);
            
            if (hab && reservaActual) {
                reservaActual.fin += 30 * 60 * 1000; // Actualiza en el array local
                try {
                    await setDoc(doc(db, 'habitaciones', String(hab.id)), hab); // Guarda en Firestore
                    alert(`Tiempo añadido a la habitación ${hab.nombre}.`);
                    mostrarPanelEmpleados(nombreEmpleado); // Refresca el panel
                } catch (e) {
                    console.error("Error al añadir tiempo a habitación en Firestore:", e);
                    alert("Error al añadir tiempo. Por favor, inténtalo de nuevo.");
                }
            }
        }

        // *** liberarHabitacion - AHORA ASÍNCRONA ***
        window.liberarHabitacion = async (id, nombreEmpleado) => { // *** AÑADIDO 'async' ***
            const hab = habitaciones.find(h => h.id === id);
            const ahora = Date.now();
            const reservaActualIndex = hab.reservas.findIndex(r => ahora >= r.inicio && ahora < r.fin);
            
            if (reservaActualIndex > -1) {
                if (confirm(`¿Seguro que quieres liberar la habitación y finalizar la sesión de '${hab.reservas[reservaActualIndex].cliente}'?`)) {
                    hab.reservas.splice(reservaActualIndex, 1); // Elimina del array local
                    try {
                        await setDoc(doc(db, 'habitaciones', String(hab.id)), hab); // Guarda en Firestore
                        alert(`Habitación ${hab.nombre} liberada.`);
                        mostrarPanelEmpleados(nombreEmpleado); // Refresca el panel
                    } catch (e) {
                        console.error("Error al liberar habitación en Firestore:", e);
                        alert("Error al liberar la habitación. Por favor, inténtalo de nuevo.");
                    }
                }
            } else {
                alert("Esta habitación no tiene una ocupación activa para liberar.");
            }
        }

        // *** publicarAnuncio - AHORA ASÍNCRONA ***
        window.publicarAnuncio = async () => { // *** AÑADIDO 'async' ***
            const texto = document.getElementById('anuncioTexto').value.trim();
            if (texto) {
                const nuevoAnuncio = { id: Date.now(), texto: texto };
                try {
                    // Firestore asignará un ID automáticamente, o podemos usar Date.now().
                    // Usaremos Date.now() como ID del documento para que podamos ordenar por él.
                    await setDoc(doc(db, 'anuncios', String(nuevoAnuncio.id)), nuevoAnuncio);
                    anuncios.unshift(nuevoAnuncio); // Añade al array local al principio
                    document.getElementById('anuncioTexto').value = '';
                    alert('Anuncio publicado.');
                    mostrarPanelAdmin(); // Refresca el panel
                } catch (e) {
                    console.error("Error al publicar anuncio en Firestore:", e);
                    alert("Error al publicar el anuncio. Por favor, inténtalo de nuevo.");
                }
            }
        }
        
        // *** mostrarAnuncios - AHORA ASÍNCRONA ***
        window.mostrarAnuncios = async (nombre) => { // *** AÑADIDO 'async' ***
            // Asegúrate de que los anuncios estén actualizados
            await cargarTodosLosAnuncios(); 
            
            let mensaje = "Últimos Anuncios:\n\n";
            if (anuncios.length === 0) {
                mensaje = "No hay anuncios recientes.";
            } else {
                // Ordena por ID descendente (más reciente primero)
                anuncios.sort((a, b) => b.id - a.id).slice(0, 5).forEach(anuncio => {
                    mensaje += `- ${anuncio.texto}\n`;
                });
            }
            alert(mensaje);
            marcarAnunciosComoVistos(nombre);
        }

        // *** marcarAnunciosComoVistos - AHORA ASÍNCRONA ***
        window.marcarAnunciosComoVistos = async (nombre) => { // *** AÑADIDO 'async' ***
            const empleado = empleados.find(e => e.nombre === nombre);
            if (empleado && anuncios.length > 0) {
                empleado.ultimoAnuncioVisto = anuncios[0].id; // Asume que anuncios[0] es el más reciente
                try {
                    await setDoc(doc(db, 'empleados', nombre), empleado); // Actualiza en Firestore
                    mostrarPanelEmpleados(nombre);
                } catch (e) {
                    console.error("Error al marcar anuncio visto en Firestore:", e);
                }
            }
        }

        // *** comprobarNuevosAnuncios - AHORA ASÍNCRONA ***
        window.comprobarNuevosAnuncios = async (nombre) => { // *** AÑADIDO 'async' ***
            const empleado = empleados.find(e => e.nombre === nombre);
            if (!empleado) return false;
            
            // Recarga los anuncios para tener la última versión
            await cargarTodosLosAnuncios();

            if (anuncios.length === 0) return false;
            const ultimoAnuncioId = anuncios[0].id; // Asume que anuncios[0] es el más reciente (si están ordenados)
            return empleado.ultimoAnuncioVisto !== ultimoAnuncioId;
        }

        // *** anadirAlLibroNegro - AHORA ASÍNCRONA ***
        window.anadirAlLibroNegro = async () => { // *** AÑADIDO 'async' ***
            const nombre = document.getElementById('libroNombre').value.trim();
            const relacion = document.getElementById('libroRelacion').value;
            const notas = document.getElementById('libroNotas').value.trim();
            if (!nombre) {
                alert("El nombre del contacto es obligatorio.");
                return;
            }
            const nuevoContacto = { id: Date.now(), nombre, relacion, notas };
            try {
                // Dejar que Firestore genere el ID del documento
                await setDoc(doc(collection(db, 'libroNegro')), nuevoContacto); // Firestore genera un ID automático
                libroNegro.push(nuevoContacto); // Añade al array local
                actualizarLibroNegro(); // Refresca la lista visual
                document.getElementById('libroNombre').value = '';
                document.getElementById('libroNotas').value = '';
            } catch (e) {
                console.error("Error al añadir al Libro Negro en Firestore:", e);
                alert("Error al añadir el contacto. Por favor, inténtalo de nuevo.");
            }
        }
        
        // *** eliminarDelLibro - AHORA ASÍNCRONA ***
        window.eliminarDelLibro = async (id) => { // *** AÑADIDO 'async' ***
            try {
                // Para eliminar un documento por su ID, necesitamos el ID del documento en Firestore.
                // Si usamos ID automático, tendríamos que buscar el documento por su 'id' interno.
                // Si lo guardamos con id: Date.now(), entonces el ID del documento es el Date.now()
                await deleteDoc(doc(db, 'libroNegro', String(id))); // Asume que el ID del documento es Date.now()
                libroNegro = libroNegro.filter(c => c.id !== id); // Elimina del array local
                actualizarLibroNegro(); // Refresca la lista visual
            } catch (e) {
                console.error("Error al eliminar del Libro Negro en Firestore:", e);
                alert("Error al eliminar el contacto. Por favor, inténtalo de nuevo.");
            }
        }

        // *** actualizarLibroNegro - AHORA ASÍNCRONA (pero se llama desde un contexto que ya debería tener los datos cargados) ***
        window.actualizarLibroNegro = () => { // No necesita ser async si 'libroNegro' ya está poblado
            const lista = document.getElementById('listaLibroNegro');
            if (!lista) return;
            lista.innerHTML = '';
            libroNegro.forEach(contacto => {
                lista.innerHTML += `<li class="flex justify-between items-center p-2 bg-purple-800 rounded"><span><strong class="capitalize">${contacto.nombre}</strong> (${contacto.relacion}) - ${contacto.notas}</span><button onclick="eliminarDelLibro(${contacto.id})" class="text-red-500 font-bold px-2">X</button></li>`;
            });
        }
        
        // *** anadirAListaNegra - AHORA ASÍNCRONA ***
        window.anadirAListaNegra = async () => { // *** AÑADIDO 'async' ***
            const nombre = document.getElementById('vetadoNombre').value.trim();
            const motivo = document.getElementById('vetadoMotivo').value.trim();
            if (!nombre || !motivo) {
                alert("El nombre y el motivo son obligatorios.");
                return;
            }
            const nuevaPersona = { id: Date.now(), nombre, motivo };
            try {
                // Dejar que Firestore genere el ID del documento
                await setDoc(doc(collection(db, 'listaNegra')), nuevaPersona); // Firestore genera un ID automático
                listaNegra.push(nuevaPersona); // Añade al array local
                actualizarListaNegra(); // Refresca la lista visual
                document.getElementById('vetadoNombre').value = '';
                document.getElementById('vetadoMotivo').value = '';
            } catch (e) {
                console.error("Error al añadir a la Lista Negra en Firestore:", e);
                alert("Error al añadir a la lista. Por favor, inténtalo de nuevo.");
            }
        }

        // *** eliminarDeListaNegra - AHORA ASÍNCRONA ***
        window.eliminarDeListaNegra = async (id) => { // *** AÑADIDO 'async' ***
            try {
                await deleteDoc(doc(db, 'listaNegra', String(id))); // Asume que el ID del documento es Date.now()
                listaNegra = listaNegra.filter(p => p.id !== id); // Elimina del array local
                actualizarListaNegra(); // Refresca la lista visual
            } catch (e) {
                console.error("Error al eliminar de la Lista Negra en Firestore:", e);
                alert("Error al eliminar. Por favor, inténtalo de nuevo.");
            }
        }

        // *** actualizarListaNegra - AHORA ASÍNCRONA (pero se llama desde un contexto que ya debería tener los datos cargados) ***
        window.actualizarListaNegra = () => { // No necesita ser async
            const lista = document.getElementById('listaDeVetados');
            if (!lista) return;
            lista.innerHTML = '';
            listaNegra.forEach(persona => {
                lista.innerHTML += `<li class="flex justify-between items-center p-2 bg-red-900 bg-opacity-50 rounded"><span><strong class="capitalize">${persona.nombre}</strong> - ${persona.motivo}</span><button onclick="eliminarDeListaNegra(${persona.id})" class="text-white font-bold px-2">X</button></li>`;
            });
        }
        
        // *** mostrarListaNegraPublica - AHORA ASÍNCRONA ***
        window.mostrarListaNegraPublica = async () => { // *** AÑADIDO 'async' ***
            // Asegúrate de tener la lista negra actualizada
            await cargarListaNegra();

            let mensaje = "--- LISTA NEGRA ---\nPersonas con acceso denegado al local:\n\n";
            if (listaNegra.length === 0) {
                mensaje += "Actualmente no hay nadie en la lista negra.";
            } else {
                listaNegra.forEach(p => {
                    mensaje += `- ${p.nombre} (Motivo: ${p.motivo})\n`;
                });
            }
            alert(mensaje);
        }

        // ===================================================================================
        //  NUEVAS FUNCIONES DE CARGA ASÍNCRONA DESDE FIRESTORE
        // ===================================================================================

        async function cargarTodosLosEmpleados() {
            try {
                const empleadosSnapshot = await getDocs(collection(db, 'empleados'));
                empleados = []; // Reinicia el array global
                if (!empleadosSnapshot.empty) {
                    empleadosSnapshot.forEach(doc => {
                        empleados.push(doc.data());
                    });
                } else {
                    // Si la colección está vacía, inicializa con los valores por defecto
                    empleados = [
                        {nombre: 'tito giovanni', passHash: hashPassword('1234'), ultimoAnuncioVisto: 0},
                        {nombre: 'marta', passHash: hashPassword('1234'), ultimoAnuncioVisto: 0}
                    ];
                    for (const emp of empleados) {
                        await setDoc(doc(db, 'empleados', emp.nombre), emp);
                    }
                    console.log("Empleados por defecto creados en Firestore.");
                }
                console.log("Empleados cargados desde Firestore:", empleados);
            } catch (e) {
                console.error("Error al cargar empleados desde Firestore:", e);
                // Asegura que 'empleados' siempre tenga un valor por defecto en caso de error grave
                if (!empleados || empleados.length === 0) {
                    empleados = [
                        {nombre: 'tito giovanni', passHash: hashPassword('1234'), ultimoAnuncioVisto: 0},
                        {nombre: 'marta', passHash: hashPassword('1234'), ultimoAnuncioVisto: 0}
                    ];
                }
            }
        }

        async function cargarTodosLosFichajes() {
            try {
                const fichajesSnapshot = await getDocs(collection(db, 'fichajes'));
                fichajes = {}; // Reinicia el objeto global
                fichajesSnapshot.forEach(doc => {
                    fichajes[doc.id] = doc.data(); // El ID del documento es el nombre del empleado
                });
                console.log("Fichajes cargados desde Firestore:", fichajes);
            } catch (e) {
                console.error("Error al cargar fichajes desde Firestore:", e);
                fichajes = {}; // En caso de error, inicializa vacío
            }
        }

        async function cargarTodasLasVentas() {
            try {
                const ventasSnapshot = await getDocs(collection(db, 'ventas'));
                ventas = {}; // Reinicia el objeto global
                ventasSnapshot.forEach(doc => {
                    ventas[doc.id] = doc.data(); // El ID del documento es el nombre del empleado
                });
                console.log("Ventas cargadas desde Firestore:", ventas);
            } catch (e) {
                console.error("Error al cargar ventas desde Firestore:", e);
                ventas = {}; // En caso de error, inicializa vacío
            }
        }

        async function cargarTodasLasHabitaciones() {
            try {
                const habitacionesSnapshot = await getDocs(collection(db, 'habitaciones'));
                habitaciones = []; // Reinicia el array global
                if (!habitacionesSnapshot.empty) {
                    habitacionesSnapshot.forEach(doc => {
                        habitaciones.push(doc.data());
                    });
                    // Asegura que siempre haya 10 habitaciones, aunque no todas tengan datos
                    if (habitaciones.length < 10) {
                        for (let i = 1; i <= 10; i++) {
                            if (!habitaciones.find(h => h.id === i)) {
                                habitaciones.push({ id: i, nombre: `Habitación ${i}`, reservas: [] });
                            }
                        }
                    }
                    // Ordenar por ID para consistencia
                    habitaciones.sort((a, b) => a.id - b.id);
                } else {
                    // Si la colección está vacía, inicializa las 10 habitaciones por defecto
                    for (let i = 1; i <= 10; i++) {
                        const nuevaHab = { id: i, nombre: `Habitación ${i}`, reservas: [] };
                        habitaciones.push(nuevaHab);
                        await setDoc(doc(db, 'habitaciones', String(i)), nuevaHab); // Guarda en Firestore
                    }
                    console.log("Habitaciones por defecto creadas en Firestore.");
                }
                console.log("Habitaciones cargadas desde Firestore:", habitaciones);
            } catch (e) {
                console.error("Error al cargar habitaciones desde Firestore:", e);
                // Si falla la carga, asegurar que al menos haya las 10 habitaciones base
                if (!habitaciones || habitaciones.length < 10) {
                    habitaciones = [];
                    for (let i = 1; i <= 10; i++) {
                        habitaciones.push({ id: i, nombre: `Habitación ${i}`, reservas: [] });
                    }
                }
            }
        }

        async function cargarTodosLosAnuncios() {
            try {
                // Cargar y ordenar por ID (que es el timestamp, para que los más recientes salgan primero)
                const anunciosQuery = query(collection(db, 'anuncios'), orderBy('id', 'desc'));
                const anunciosSnapshot = await getDocs(anunciosQuery);
                anuncios = []; // Reinicia el array global
                anunciosSnapshot.forEach(doc => {
                    anuncios.push(doc.data());
                });
                console.log("Anuncios cargados desde Firestore:", anuncios);
            } catch (e) {
                console.error("Error al cargar anuncios desde Firestore:", e);
                anuncios = []; // En caso de error, inicializa vacío
            }
        }

        async function cargarLibroNegro() {
            try {
                const libroNegroSnapshot = await getDocs(collection(db, 'libroNegro'));
                libroNegro = []; // Reinicia el array global
                libroNegroSnapshot.forEach(doc => {
                    libroNegro.push(doc.data());
                });
                console.log("Libro Negro cargado desde Firestore:", libroNegro);
            } catch (e) {
                console.error("Error al cargar Libro Negro desde Firestore:", e);
                libroNegro = []; // En caso de error, inicializa vacío
            }
        }

        async function cargarListaNegra() {
            try {
                const listaNegraSnapshot = await getDocs(collection(db, 'listaNegra'));
                listaNegra = []; // Reinicia el array global
                listaNegraSnapshot.forEach(doc => {
                    listaNegra.push(doc.data());
                });
                console.log("Lista Negra cargada desde Firestore:", listaNegra);
            } catch (e) {
                console.error("Error al cargar Lista Negra desde Firestore:", e);
                listaNegra = []; // En caso de error, inicializa vacío
            }
        }

        // ===================================================================================
        //  INICIALIZACIÓN PRINCIPAL - CARGA TODOS LOS DATOS AL INICIO
        // ===================================================================================
        console.log("Iniciando carga de datos desde Firestore...");
        await cargarTodosLosEmpleados();
        await cargarTodosLosFichajes();
        await cargarTodasLasVentas();
        await cargarTodasLasHabitaciones();
        await cargarTodosLosAnuncios();
        await cargarLibroNegro();
        await cargarListaNegra();
        console.log("Carga de datos desde Firestore completada.");


        const currentUser = sessionStorage.getItem('currentUser'); // Sigue usando sessionStorage para la sesión actual
        if (currentUser && empleados.find(e => e.nombre === currentUser)) {
            // Recargar datos específicos del usuario si ya había una sesión
            await gestionarReseteoDatos(currentUser); // Fichajes
            await gestionarReseteoDatos(currentUser, true); // Ventas
            mostrarPanelEmpleados(currentUser);
            const datosFichaje = fichajes[currentUser];
            if (datosFichaje && datosFichaje.fichado) {
                iniciarRelojFichaje(datosFichaje.inicio, datosFichaje.hoy, datosFichaje.semana, datosFichaje.total);
            }
        } else {
            mostrarInicio();
        }
    });
  </script></body></html>
