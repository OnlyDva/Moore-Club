<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Moore Club - La Tentaci√≥n Empieza Aqu√≠</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: url('mooreclub1.webp') center top no-repeat;
      background-size: cover;
      background-attachment: fixed;
      color: white;
    }
    .bg-overlay { background-color: rgba(0, 0, 0, 0.85); }
    .btn {
      background-color: #6b21a8; color: white; padding: 0.5rem 1rem;
      border-radius: 0.375rem; font-weight: 600; cursor: pointer;
      transition: background-color 0.3s; margin-right: 0.5rem;
    }
    .btn:hover { background-color: #5b189b; }
    .producto-card img {
      border-radius: 0.5rem; height: 96px; width: 96px;
      object-fit: cover;
    }
    #contenido { min-height: 60vh; }
    .notification-dot {
        height: 8px; width: 8px; background-color: #ef4444;
        border-radius: 50%; position: absolute; top: 0; right: 0;
    }

    /* Estilos para el Chatbot */
    #chatbot-button {
        position: fixed;
        bottom: 150px; /* M√°s arriba, altura media */
        right: 20px;
        border-radius: 50%;
        width: 100px; /* M√°s grande */
        height: 100px; /* M√°s grande */
        overflow: hidden; /* Para asegurar que la imagen se recorte en el c√≠rculo */
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
        cursor: pointer;
        z-index: 1000;
        transition: transform 0.3s ease;
        animation: pulse 2s infinite;
    }
    #chatbot-button img {
        width: 100%;
        height: 100%;
        object-fit: cover; /* Ajusta la imagen para que cubra el c√≠rculo, recortando si es necesario */
        display: block;
    }
    #chatbot-button:hover {
        transform: scale(1.05);
    }
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }

    #chatbot-container {
        position: fixed;
        bottom: 260px; /* Encima del bot√≥n m√°s grande (150px + 100px + 10px margen) */
        right: 20px;
        width: 450px; /* M√°s grande */
        height: 600px; /* M√°s grande */
        background-color: #1a1a2e;
        border-radius: 10px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
        display: flex;
        flex-direction: column;
        z-index: 999;
        overflow: hidden;
        border: 2px solid #6b21a8;
        display: none; /* Oculto por defecto */
    }
    #chatbot-header {
        background-color: #6b21a8;
        color: white;
        padding: 10px 15px;
        font-weight: bold;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-top-left-radius: 8px;
        border-top-right-radius: 8px;
    }
    #chatbot-close {
        background: none;
        border: none;
        color: white;
        font-size: 1.2em;
        cursor: pointer;
    }
    /* Estilo para el nuevo bot√≥n de minimizar */
    #chatbot-minimize {
        background: none;
        border: none;
        color: white;
        font-size: 1.5em; /* Un poco m√°s grande para el icono de "-" */
        cursor: pointer;
        margin-right: 10px; /* Espacio entre minimizar y cerrar */
    }
    #chatbot-messages {
        flex-grow: 1;
        padding: 15px;
        overflow-y: auto;
        background-color: #2a2a4a;
        border-bottom: 1px solid #4a4a6e;
        display: flex; /* A√±adido para que los mensajes se alineen correctamente */
        flex-direction: column; /* A√±adido para que los mensajes se apilen verticalmente */
    }
    .message {
        margin-bottom: 10px;
        padding: 8px 12px;
        border-radius: 15px;
        max-width: 80%;
        line-height: 1.4;
    }
    .message.user {
        background-color: #a855f7;
        color: white;
        align-self: flex-end;
        margin-left: auto;
        border-bottom-right-radius: 2px;
    }
    .message.bot {
        background-color: #4a4a6e;
        color: white;
        align-self: flex-start;
        margin-right: auto;
        border-bottom-left-radius: 2px;
    }
    #chatbot-input-container {
        padding: 10px 15px;
        display: flex;
        gap: 10px;
        background-color: #1a1a2e;
    }
    #chatbot-input {
        flex-grow: 1;
        padding: 10px;
        border-radius: 20px;
        border: 1px solid #6b21a8;
        background-color: #333355;
        color: white;
        font-size: 0.9em;
    }
    #chatbot-send {
        background-color: #6b21a8;
        color: white;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        font-size: 1.2em;
        transition: background-color 0.3s;
    }
    #chatbot-send:hover {
        background-color: #5b189b;
    }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, setDoc, updateDoc, deleteDoc, getDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAjSUwa9HtVsxBhY__73XdLbWXHmlcIyUE",
      authDomain: "moore-club.firebaseapp.com",
      projectId: "moore-club",
      storageBucket: "moore-club.appspot.com",
      messagingSenderId: "674972089844",
      appId: "1:674972089844:web:9d6f9680bec8f6cff98da1",
      measurementId: "G-RSPNMJ466D"
    };

    // Inicializaci√≥n de Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Hacer accesibles las funciones de Firebase globalmente si es necesario
    window.db = db;
    window.collection = collection;
    window.getDocs = getDocs;
    window.doc = doc;
    window.setDoc = setDoc;
    window.updateDoc = updateDoc;
    window.deleteDoc = deleteDoc;
    window.getDoc = getDoc;
    window.query = query;
    window.orderBy = orderBy;
  </script>
</head>
<body class="text-purple-200">
  <div class="bg-overlay min-h-screen">
    <nav class="bg-purple-900 text-white px-6 py-4 flex justify-between items-center">
      <h1 class="text-xl font-bold cursor-pointer" onclick="mostrarInicio()">Moore Club</h1>
      <ul class="flex space-x-6 text-sm">
        <li><a href="#" onclick="mostrarInicio()" class="hover:underline">Inicio</a></li>
        <li><a href="#" onclick="mostrarLoginVIP()" class="hover:underline">Empleados</a></li>
        <li><a href="#" onclick="mostrarPanelProductos()" class="hover:underline">Productos</a></li>
        <li><a href="#" onclick="mostrarPanelHabitaciones()" class="hover:underline">Habitaciones</a></li>
      </ul>
    </nav>
    <main id="contenido" class="p-8"></main>
  </div>

  <div id="chatbot-button">
      <img src="Luna.png" alt="Asistente de Chatbot" />
  </div>

  <div id="chatbot-container">
    <div id="chatbot-header">
      Asistente Moore Club
      <div>
          <button id="chatbot-minimize" title="Minimizar">_</button>
          <button id="chatbot-close" title="Cerrar">X</button>
      </div>
    </div>
    <div id="chatbot-messages">
      </div>
    <div id="chatbot-input-container">
        <input type="text" id="chatbot-input" placeholder="Escribe tu mensaje...">
        <button id="chatbot-send">&#10148;</button>
    </div>
  </div>

  <script>
    // ===================================================================================
    //  1. ESTADO GLOBAL Y DATOS DE LA APLICACI√ìN
    // ===================================================================================
    
    // Variables de estado y datos
    let empleados = [];
    let fichajes = {};
    let ventas = {};
    let habitaciones = [];
    let anuncios = [];
    let libroNegro = [];
    let listaNegra = [];

    // Lista est√°tica de productos
    const productos = [ { id: 'tito_griego', nombre: 'Tito Dios Griego', imagen: 'Tito.png' }, { id: 'la_tita', nombre: 'La Tita', imagen: 'Tita.png' }, { id: 'mascara_cat', nombre: 'M√°scara Dominante ‚ÄúCat Vanilla‚Äù', imagen: 'Mascara.png' }, { id: 'pinzas_led', nombre: 'Pinzas LED ‚ÄúSweet Pain‚Äù', imagen: 'Pinzas.png' }, { id: 'preservativos', nombre: 'Preservativos ‚ÄúEspadas del Deseo‚Äù', imagen: 'condones.png' }, { id: 'dildo_doble', nombre: 'Dildo Doble ‚ÄúFusi√≥n Morada‚Äù', imagen: 'Dildo.webp' }, { id: 'banana', nombre: 'Banana Pelada', imagen: 'banana.png' }, { id: 'magdalenas', nombre: 'Magdalenas con Glaseado Rosa', imagen: 'magdalenas.png' }, { id: 'berenjena', nombre: 'Berenjena Rellena', imagen: 'berenjena.png' }, { id: 'coctel', nombre: 'C√≥ctel Dulce', imagen: 'Coctel.png' }, { id: 'trago_afrutado', nombre: 'Trago Afrutado', imagen: 'trago afrutado.png' }, { id: 'almejas', nombre: 'Almejas', imagen: 'almejas.png' }];

    // Intervalos para relojes y actualizaciones
    let fichajeInterval = null, habitacionesInterval = null, dashboardInterval = null;
    const OPENAI_MODEL = "gpt-3.5-turbo";

    // ===================================================================================
    //  2. FUNCIONES AUXILIARES GLOBALES
    // ===================================================================================
    
    // Funciones de utilidad (hashing, formato de tiempo, etc.)
    window.hashPassword = (str) => {
        let hash = 0; if (typeof str !== 'string' || str.length === 0) return "hash_0";
        for (let i = 0; i < str.length; i++) { const char = str.charCodeAt(i); hash = ((hash << 5) - hash) + char; hash |= 0; }
        return "hash_" + Math.abs(hash);
    }
    window.formatearTiempo = (ms) => {
        if (isNaN(ms) || ms < 0) ms = 0; const totalSegundos = Math.floor(ms / 1000);
        const horas = String(Math.floor(totalSegundos / 3600)).padStart(2, '0');
        const minutos = String(Math.floor((totalSegundos % 3600) / 60)).padStart(2, '0');
        const segundos = String(totalSegundos % 60).padStart(2, '0');
        return `${horas}:${minutos}:${segundos}`;
    }
    window.getWeekNumber = (d) => {
        d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
        var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
        return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
    }
    window.getEstadoHabitacion = (hab) => {
        const ahora = Date.now();
        if (!hab || !hab.reservas) return { estado: 'disponible', texto: 'Disponible', reservaActual: null };
        const reservaActual = hab.reservas.find(r => ahora >= r.inicio && ahora < r.fin);
        if (reservaActual) { return { estado: 'ocupada', texto: 'Ocupada', reservaActual }; }
        return { estado: 'disponible', texto: 'Disponible', reservaActual: null };
    }
    
    // Funciones para controlar los intervalos de actualizaci√≥n
    const detenerRelojFichaje = () => { if (fichajeInterval) { clearInterval(fichajeInterval); fichajeInterval = null; } }
    const detenerRelojHabitaciones = () => { if(habitacionesInterval) { clearInterval(habitacionesInterval); habitacionesInterval = null; } }
    const detenerDashboard = () => { if(dashboardInterval) { clearInterval(dashboardInterval); dashboardInterval = null; } }


    // ===================================================================================
    //  3. L√ìGICA DEL CHATBOT
    // ===================================================================================

    function addMessage(text, sender) {
        const chatbotMessages = document.getElementById('chatbot-messages');
        const messageElement = document.createElement('div');
        messageElement.classList.add('message', sender);
        messageElement.textContent = text;
        chatbotMessages.appendChild(messageElement);
        chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
    }

    async function sendMessageToOpenAI(message) {
        addMessage(message, 'user');
        const chatbotMessages = document.getElementById('chatbot-messages');
        const chatbotInput = document.getElementById('chatbot-input');

        try {
            addMessage('Escribiendo...', 'bot');

            // Esta es la parte que requiere un backend (Netlify Function en tu caso)
            // Aseg√∫rate de que la URL '/netlify/functions/openai-chat' es correcta
            const response = await fetch('/netlify/functions/openai-chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: OPENAI_MODEL,
                    messages: [
                        { role: "system", content: "Eres un asistente amable y servicial para el Moore Club. Tu nombre es Asistente Moore Club. No puedes realizar acciones en la p√°gina, solo responder preguntas. S√© conciso y elegante." },
                        { role: "user", content: message }
                    ],
                    temperature: 0.7
                })
            });

            const data = await response.json();
            
            if (chatbotMessages.lastChild && chatbotMessages.lastChild.textContent === 'Escribiendo...') {
                chatbotMessages.removeChild(chatbotMessages.lastChild);
            }

            if (response.ok) {
                const botResponse = data.result;
                addMessage(botResponse, 'bot');
            } else {
                console.error('Error de la Netlify Function:', data);
                addMessage(`Lo siento, hubo un error al procesar tu solicitud: ${data.error || 'Error desconocido'}`, 'bot');
            }
        } catch (error) {
            if (chatbotMessages.lastChild && chatbotMessages.lastChild.textContent === 'Escribiendo...') {
                chatbotMessages.removeChild(chatbotMessages.lastChild);
            }
            console.error('Error al conectar con la Netlify Function:', error);
            addMessage('Lo siento, no pude conectar con el asistente en este momento. Int√©ntalo m√°s tarde.', 'bot');
        } finally {
            chatbotInput.value = '';
        }
    }
    
    // ===================================================================================
    //  4. FUNCIONES DE CARGA DE DATOS (FIRESTORE)
    // ===================================================================================
    
    async function cargarTodosLosEmpleados() {
        try {
            const empleadosSnapshot = await getDocs(window.collection(window.db, 'empleados'));
            empleados = [];
            if (!empleadosSnapshot.empty) {
                empleadosSnapshot.forEach(doc => empleados.push(doc.data()));
            } else {
                console.log("Creando empleados por defecto...");
                empleados = [
                    {nombre: 'tito giovanni', passHash: hashPassword('1234'), ultimoAnuncioVisto: 0},
                    {nombre: 'marta', passHash: hashPassword('1234'), ultimoAnuncioVisto: 0}
                ];
                for (const emp of empleados) {
                    await window.setDoc(window.doc(window.db, 'empleados', emp.nombre), emp);
                }
            }
        } catch (e) { console.error("Error al cargar empleados:", e); }
    }

    async function cargarTodosLosFichajes() {
        try {
            const fichajesSnapshot = await getDocs(window.collection(window.db, 'fichajes'));
            fichajes = {};
            fichajesSnapshot.forEach(doc => { fichajes[doc.id] = doc.data(); });
        } catch (e) { console.error("Error al cargar fichajes:", e); }
    }
    
    async function cargarTodasLasVentas() {
        try {
            const ventasSnapshot = await getDocs(window.collection(window.db, 'ventas'));
            ventas = {};
            ventasSnapshot.forEach(doc => { ventas[doc.id] = doc.data(); });
        } catch (e) { console.error("Error al cargar ventas:", e); }
    }

    async function cargarTodasLasHabitaciones() {
        try {
            const habitacionesSnapshot = await getDocs(window.collection(window.db, 'habitaciones'));
            habitaciones = [];
            if (!habitacionesSnapshot.empty) {
                habitacionesSnapshot.forEach(doc => habitaciones.push(doc.data()));
            }
            
            // Si no hay habitaciones o hay menos de 10, crea las por defecto.
            if (habitaciones.length < 10) {
                 for (let i = 1; i <= 10; i++) {
                     if (!habitaciones.find(h => h.id === i)) {
                         const nuevaHab = { id: i, nombre: `Habitaci√≥n ${i}`, reservas: [] };
                         habitaciones.push(nuevaHab);
                         await window.setDoc(window.doc(window.db, 'habitaciones', String(i)), nuevaHab);
                     }
                 }
            }
            habitaciones.sort((a, b) => a.id - b.id);
        } catch (e) { console.error("Error al cargar habitaciones:", e); }
    }

    async function cargarTodosLosAnuncios() {
        try {
            const anunciosQuery = window.query(window.collection(window.db, 'anuncios'), window.orderBy('id', 'desc'));
            const anunciosSnapshot = await getDocs(anunciosQuery);
            anuncios = [];
            anunciosSnapshot.forEach(doc => anuncios.push(doc.data()));
        } catch (e) { console.error("Error al cargar anuncios:", e); }
    }

    async function cargarLibroNegro() {
        try {
            const libroSnapshot = await getDocs(window.collection(window.db, 'libroNegro'));
            libroNegro = [];
            libroSnapshot.forEach(doc => libroNegro.push(doc.data()));
        } catch (e) { console.error("Error al cargar libro negro:", e); }
    }

    async function cargarListaNegra() {
        try {
            const listaSnapshot = await getDocs(window.collection(window.db, 'listaNegra'));
            listaNegra = [];
            listaSnapshot.forEach(doc => listaNegra.push(doc.data()));
        } catch (e) { console.error("Error al cargar lista negra:", e); }
    }


    // ===================================================================================
    //  5. FUNCIONES DE L√ìGICA DE NEGOCIO Y RENDERIZADO
    // ===================================================================================

    // Funci√≥n para limpiar todos los intervalos activos
    function detenerTodosLosIntervalos() {
        detenerRelojFichaje();
        detenerRelojHabitaciones();
        detenerDashboard();
    }
    
    // --- VISTAS PRINCIPALES ---

    window.mostrarInicio = () => {
        detenerTodosLosIntervalos();
        document.getElementById('contenido').innerHTML = `<div class="p-4 md:p-8 max-w-7xl mx-auto rounded-lg bg-purple-900 bg-opacity-90 shadow-lg"><header class="mb-8 text-center"><h1 class="text-5xl font-extrabold text-white drop-shadow-lg mb-2">Bienvenido a Moore Club</h1><p class="text-purple-300 text-lg">Donde la tentaci√≥n y la elegancia se encuentran.</p></header><div class="flex flex-col md:flex-row items-center gap-8"><div class="md:w-5/12"><img src="Tito y Marta.png" alt="Tito y Marta" class="rounded-lg shadow-2xl w-full h-auto object-cover" /></div><div class="md:w-7/12 space-y-6"><div class="bg-purple-800 bg-opacity-50 p-4 rounded-lg"><h2 class="text-2xl font-bold text-white mb-2">Tito Giovanni</h2><p class="text-purple-200">El carism√°tico maestro de ceremonias y coraz√≥n de Moore. Su elegancia y estilo inconfundible, siempre vestido de morado, garantizan una noche inolvidable. Es el anfitri√≥n perfecto, el alma de la fiesta.</p></div><div class="bg-purple-800 bg-opacity-50 p-4 rounded-lg"><h2 class="text-2xl font-bold text-white mb-2">Marta</h2><p class="text-purple-200">La musa indiscutible del club. Con una actitud que cautiva y una sensualidad que desarma, Marta es la protagonista de los shows m√°s aclamados. Su presencia en el escenario es pura magia y provocaci√≥n.</p></div></div></div><div class="mt-10 flex justify-center gap-4"><button onclick="mostrarLoginVIP()" class="btn">√Årea Empleados</button><button onclick="mostrarLoginAdmin()" class="btn" style="background-color: #a855f7;">Tito Giovanni</button></div></div>`;
    }

    window.mostrarLoginVIP = () => {
        detenerTodosLosIntervalos();
        document.getElementById('contenido').innerHTML = `<div class="max-w-md mx-auto bg-black bg-opacity-30 p-8 rounded-lg shadow-lg"><h2 class="text-2xl font-bold mb-4 text-center">Acceso Empleados</h2><div class="mb-4"><label class="block mb-2">Nombre completo:</label><input id="nombreInput" type="text" class="w-full px-3 py-2 text-black rounded" placeholder="nombre y apellido en min√∫sculas" /></div><div class="mb-4"><label class="block mb-2">Contrase√±a:</label><input id="passInput" type="password" class="w-full px-3 py-2 text-black rounded" /></div><div class="flex justify-between mt-6"><button onclick="verificarAccesoVIP()" class="btn">Entrar</button><button onclick="mostrarInicio()" class="btn" style="background-color:#5b189b;">Volver</button></div></div>`;
    }

    window.mostrarLoginAdmin = () => {
        detenerTodosLosIntervalos();
        document.getElementById('contenido').innerHTML = `<div class="max-w-md mx-auto bg-black bg-opacity-50 p-8 rounded-lg shadow-lg border-2 border-purple-400"><h2 class="text-3xl font-bold mb-4 text-center text-purple-300">Acceso Privado - Tito Giovanni</h2><label class="block mb-2">Contrase√±a de Administrador:</label><input id="adminPassInput" type="password" class="w-full px-3 py-2 text-black rounded" /><div class="flex justify-between mt-6"><button onclick="verificarAccesoAdmin()" class="btn">Entrar</button><button onclick="mostrarInicio()" class="btn" style="background-color:#5b189b;">Volver</button></div></div>`;
    }
    
    window.mostrarPanelProductos = () => {
        detenerTodosLosIntervalos();
        document.getElementById('contenido').innerHTML = `<h2 class="text-2xl font-bold mb-6 text-center">Productos Moore Club</h2><div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-6">${productos.map(p => crearTarjetaProducto(p, false)).join('')}</div><div class="text-center"><button onclick="mostrarInicio()" class="btn mt-8">Volver</button></div>`;
    }

    window.mostrarPanelHabitaciones = async () => {
        detenerTodosLosIntervalos();
        if (habitaciones.length === 0) await cargarTodasLasHabitaciones();
        
        let html = `<div class="max-w-7xl mx-auto text-center"><h1 class="text-4xl font-bold mb-8">Nuestras Habitaciones</h1><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">`;
        habitaciones.forEach(hab => {
            const estadoActual = getEstadoHabitacion(hab);
            html += `<div class="border-2 ${estadoActual.estado === 'disponible' ? 'border-purple-600' : 'border-gray-600'} p-4 rounded-lg bg-purple-900 bg-opacity-50 flex flex-col"><div class="flex-grow flex gap-4"><div class="w-1/3 bg-black/20 rounded"></div><div class="w-2/3 text-left"><h2 class="text-2xl font-bold">${hab.nombre}</h2><p class="text-lg ${estadoActual.estado === 'disponible' ? 'text-green-400' : 'text-red-400'}">${estadoActual.texto}</p><div class="mt-2 text-sm"><p class="font-bold mb-1">Reservas para hoy:</p><ul class="list-disc list-inside space-y-1 h-20 overflow-y-auto text-xs">${hab.reservas.filter(r => new Date(r.inicio).toDateString() === new Date().toDateString()).sort((a,b)=>a.inicio-b.inicio).map(r => `<li>${new Date(r.inicio).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})} - ${new Date(r.fin).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})} (${r.cliente})</li>`).join('') || '<li>Ninguna reserva hoy.</li>'}</ul></div></div></div><div id="form-hab-${hab.id}" class="mt-3 text-left border-t border-purple-800 pt-3"><h4 class="font-bold mb-2 text-center">Hacer una nueva reserva:</h4><input type="text" id="cliente-hab-${hab.id}" placeholder="Tu nombre" class="w-full p-2 rounded bg-gray-800 text-white mb-2 text-sm"><div class="flex gap-2"><input type="date" id="fecha-hab-${hab.id}" class="w-full p-2 rounded bg-gray-800 text-white mb-2 text-sm"><input type="time" id="hora-hab-${hab.id}" step="1800" class="w-full p-2 rounded bg-gray-800 text-white mb-2 text-sm"></div><select id="duracion-hab-${hab.id}" class="w-full p-2 rounded bg-gray-800 text-white mb-2 text-sm"><option value="1">1 Hora</option><option value="2">2 Horas</option><option value="3">3 Horas</option></select><button class="btn w-full mt-2" onclick="reservarHabitacion(${hab.id})">Confirmar Reserva</button></div></div>`;
        });
        html += `</div></div>`;
        document.getElementById('contenido').innerHTML = html;
        
        const hoy = new Date(); const unaSemana = new Date(hoy); unaSemana.setDate(hoy.getDate() + 7);
        const minDate = hoy.toISOString().split('T')[0]; const maxDate = unaSemana.toISOString().split('T')[0];
        document.querySelectorAll('input[type="date"]').forEach(input => { input.min = minDate; input.max = maxDate; input.value = minDate; });
    }

    window.cerrarSesion = () => {
        detenerTodosLosIntervalos();
        sessionStorage.removeItem('currentUser');
        mostrarInicio();
    }
    
    // --- L√ìGICA DE LOGIN Y PANELES ---

    window.verificarAccesoVIP = async () => {
        const nombre = document.getElementById('nombreInput')?.value.trim().toLowerCase();
        const pass = document.getElementById('passInput')?.value;
        if (!nombre || !pass) return alert('Nombre y contrase√±a requeridos.');

        const empleado = empleados.find(e => e.nombre === nombre);

        if (empleado && hashPassword(pass) === empleado.passHash) {
            sessionStorage.setItem('currentUser', nombre);
            // CORRECCI√ìN: Usar 'nombre' para cargar los datos antes de mostrar el panel
            await gestionarReseteoDatos(nombre);
            await gestionarReseteoDatos(nombre, true);
            mostrarPanelEmpleados(nombre);
        } else {
            alert('Nombre de usuario o contrase√±a incorrectos.');
        }
    }

    window.verificarAccesoAdmin = async () => {
        const adminPassInput = document.getElementById('adminPassInput');
        if (adminPassInput?.value === "D.VaSong11") {
            mostrarPanelAdmin();
        } else {
            alert('Contrase√±a incorrecta.');
        }
    }

    window.mostrarPanelEmpleados = async (nombre) => {
        detenerTodosLosIntervalos();

        await gestionarReseteoDatos(nombre);
        await gestionarReseteoDatos(nombre, true);
        
        const datosFichaje = fichajes[nombre] || { hoy: 0, semana: 0, total: 0, fichado: false, inicio: null };
        const productosVentaHTML = productos.map(p => crearTarjetaProducto(p, true, nombre)).join('');
        
        if (habitaciones.length === 0) await cargarTodasLasHabitaciones();
        let habitacionesHTML = '';
        habitaciones.forEach(hab => {
            const estadoActual = getEstadoHabitacion(hab);
            let controles = '';
            if (estadoActual.estado === 'disponible') {
                controles = `<button class="btn text-sm py-2 w-full" onclick="ocuparHabitacionAhora(${hab.id}, '${nombre}')">Ocupar (30 min)</button>`;
            } else {
                controles = `<div class="font-mono text-xl mb-2" id="timer-hab-${hab.id}">--:--:--</div><div class="flex gap-2"><button class="btn text-xs py-1 flex-grow" onclick="anadirTiempoHabitacion(${hab.id}, '${nombre}')">+30 min</button><button class="btn text-xs py-1 flex-grow" style="background-color:#c44" onclick="liberarHabitacion(${hab.id}, '${nombre}')">Liberar</button></div>`;
            }
            habitacionesHTML += `<div class="bg-purple-800 p-4 rounded-lg text-center flex flex-col justify-between"><div><p class="font-bold text-lg">${hab.nombre}</p><p class="text-sm ${estadoActual.estado === 'ocupada' ? 'text-red-400' : 'text-green-400'} mb-2">${estadoActual.texto}</p></div><div>${controles}</div></div>`;
        });
        
        const hayNotificaciones = await comprobarNuevosAnuncios(nombre);
        const notificacionHTML = `<div class="relative"><button onclick="mostrarAnuncios('${nombre}')" class="text-2xl">üîî</button>${hayNotificaciones ? '<div class="notification-dot"></div>' : ''}</div>`;
        const listaNegraBtn = `<button onclick="mostrarListaNegraPublica()" class="btn text-xs py-1">Ver Vetados</button>`;

        document.getElementById('contenido').innerHTML = `<div class="p-6 bg-purple-900 bg-opacity-90 rounded-lg max-w-6xl mx-auto shadow-lg"><div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold">Panel de Fichaje: <span class="text-purple-300 capitalize">${nombre}</span></h2><div class="flex items-center gap-4">${listaNegraBtn}${notificacionHTML}<button class="btn" style="background-color: #d63636;" onclick="cerrarSesion()">Cerrar Sesi√≥n</button></div></div><div class="bg-purple-800 p-4 rounded-lg mb-6 grid grid-cols-1 md:grid-cols-4 gap-4 text-center items-center"><div><p class="text-sm text-purple-300">TIEMPO HOY</p><p id="tiempoHoy" class="font-mono text-xl">${formatearTiempo(datosFichaje.hoy)}</p></div><div><p class="text-sm text-purple-300">TIEMPO SEMANA</p><p id="tiempoSemana" class="font-mono text-xl">${formatearTiempo(datosFichaje.semana)}</p></div><div><p class="text-sm text-purple-300">TIEMPO TOTAL</p><p id="tiempoTotal" class="font-mono text-xl">${formatearTiempo(datosFichaje.total)}</p></div><div class="bg-purple-700 p-2 rounded-lg"><p class="text-sm text-purple-200">SESI√ìN ACTUAL</p><p id="tiempoSesion" class="font-mono text-xl font-bold text-white">00:00:00</p></div></div><div class="text-center mb-8"><button class="btn text-lg px-6 py-3" onclick="fichar('${nombre}')">Fichar Entrada</button><button class="btn text-lg px-6 py-3" onclick="desfichar('${nombre}')">Fichar Salida</button></div> <h3 class="text-xl font-semibold mb-4 border-t border-purple-700 pt-6">Gesti√≥n de Habitaciones</h3><div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-8">${habitacionesHTML}</div> <h3 class="text-xl font-semibold mb-4 border-t border-purple-700 pt-6">Registrar Ventas</h3><div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4" id="productosVenta">${productosVentaHTML}</div></div>`;

        iniciarRelojHabitaciones();
        if (datosFichaje.fichado) {
            iniciarRelojFichaje(datosFichaje.inicio, datosFichaje.hoy, datosFichaje.semana, datosFichaje.total);
        }
    }
    
    // Aqu√≠ ir√≠an el resto de tus funciones como `fichar`, `desfichar`, `reservarHabitacion`, `mostrarPanelAdmin`, etc.
    // He incluido algunas de ellas para que el c√≥digo sea funcional. Las dem√°s puedes copiarlas de tu versi√≥n original
    // asegur√°ndote de que est√°n en el √°mbito global (usando `window.nombreFuncion = ...`).
    
    window.gestionarReseteoDatos = async (nombre, esVenta = false) => {
        const ahora = new Date();
        const anio = ahora.getFullYear();
        const mes = String(ahora.getMonth() + 1).padStart(2, '0');
        const dia = String(ahora.getDate()).padStart(2, '0');
        const hoyStr = `${anio}-${mes}-${dia}`;
        const semanaNum = getWeekNumber(ahora);

        if (esVenta) {
            let datosVentaDoc = await window.getDoc(window.doc(window.db, 'ventas', nombre));
            let datosV = datosVentaDoc.exists() ? datosVentaDoc.data() : { productos: {}, fecha: '' };
            if (typeof datosV !== 'object' || Array.isArray(datosV)) datosV = { productos: {}, fecha: '' };
            if (!datosV.productos) datosV.productos = {};
            if (datosV.fecha !== hoyStr) {
                datosV.fecha = hoyStr;
                Object.keys(datosV.productos).forEach(key => { datosV.productos[key].hoy = 0; });
            }
            ventas[nombre] = datosV;
            return datosV;
        } else {
            let datosFichajeDoc = await window.getDoc(window.doc(window.db, 'fichajes', nombre));
            let datosF = datosFichajeDoc.exists() ? datosFichajeDoc.data() : null;
            if (!datosF || typeof datosF.total !== 'number') {
                datosF = { total: 0, hoy: 0, semana: 0, fecha: hoyStr, numSemana: semanaNum, fichado: false, inicio: null };
            }
            if (datosF.fecha !== hoyStr) { datosF.hoy = 0; datosF.fecha = hoyStr; }
            if (datosF.numSemana !== semanaNum) { datosF.semana = 0; datosF.numSemana = semanaNum; }
            fichajes[nombre] = datosF;
            return datosF;
        }
    }

    window.crearTarjetaProducto = (producto, esPanelVenta = false, nombreEmpleado = '') => {
        let totalVentasHoy = 0;
        let totalVentasHist = 0;
        if (esPanelVenta && ventas[nombreEmpleado] && ventas[nombreEmpleado].productos && ventas[nombreEmpleado].productos[producto.id]) {
            totalVentasHoy = ventas[nombreEmpleado].productos[producto.id].hoy || 0;
            totalVentasHist = ventas[nombreEmpleado].productos[producto.id].total || 0;
        }
        const desc = `Hoy: ${totalVentasHoy} | Total: ${totalVentasHist}`;
        const inputVentasHTML = esPanelVenta ? `<div class="mt-2"><input type="number" min="0" value="0" id="input-${producto.id}" class="w-20 px-2 py-1 text-black rounded" onchange="actualizarVentas('${producto.id}', '${nombreEmpleado}')" /><p class="text-xs mt-1">${desc}</p></div>` : `<p class="text-purple-300 text-sm mt-2">${producto.descripcion || ''}</p>`;
        return `<div class="producto-card bg-purple-800 rounded-lg p-2 text-center shadow-md flex flex-col justify-between text-sm"><div><img src="${producto.imagen}" alt="${producto.nombre}" class="mx-auto mb-2 w-20 h-20 object-cover rounded" /><h3 class="text-white font-semibold leading-tight">${producto.nombre}</h3></div><div>${inputVentasHTML}</div></div>`;
    }

    window.actualizarVentas = async (productoId, nombreEmpleado) => {
        const cantidadInput = document.getElementById(`input-${productoId}`);
        const cantidad = parseInt(cantidadInput.value);
        if (isNaN(cantidad) || cantidad <= 0) {
            alert("Por favor, introduce una cantidad v√°lida mayor que cero.");
            cantidadInput.value = '0'; return;
        }
        try {
            let datosVenta = ventas[nombreEmpleado] || { productos: {}, fecha: '' };
            if (!datosVenta.productos[productoId]) {
                datosVenta.productos[productoId] = { hoy: 0, total: 0 };
            }
            datosVenta.productos[productoId].hoy += cantidad;
            datosVenta.productos[productoId].total += cantidad;
            datosVenta.fecha = new Date().toISOString().split('T')[0];
            ventas[nombreEmpleado] = datosVenta;
            await window.setDoc(window.doc(window.db, 'ventas', nombreEmpleado), datosVenta);
            cantidadInput.value = '0';
            mostrarPanelEmpleados(nombreEmpleado);
        } catch (e) {
            console.error("Error al actualizar ventas:", e);
            alert("Error al registrar la venta.");
        }
    };
    
    // ... (El resto de tus funciones como `fichar`, `desfichar`, `reservarHabitacion`, etc. ir√≠an aqu√≠)
    
    // ===================================================================================
    //  6. INICIALIZACI√ìN DE LA APLICACI√ìN
    // ===================================================================================
    
    document.addEventListener('DOMContentLoaded', async () => {
        // --- EVENT LISTENERS DEL CHATBOT ---
        const chatbotButton = document.getElementById('chatbot-button');
        const chatbotContainer = document.getElementById('chatbot-container');
        const chatbotCloseButton = document.getElementById('chatbot-close');
        const chatbotMinimizeButton = document.getElementById('chatbot-minimize');
        const chatbotInput = document.getElementById('chatbot-input');
        const chatbotSendButton = document.getElementById('chatbot-send');

        chatbotButton.addEventListener('click', () => {
            chatbotContainer.style.display = chatbotContainer.style.display === 'flex' ? 'none' : 'flex';
        });
        chatbotCloseButton.addEventListener('click', () => {
            chatbotContainer.style.display = 'none';
        });
        chatbotMinimizeButton.addEventListener('click', () => {
            chatbotContainer.style.display = 'none';
        });
        chatbotSendButton.addEventListener('click', () => {
            const message = chatbotInput.value.trim();
            if (message) sendMessageToOpenAI(message);
        });
        chatbotInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') chatbotSendButton.click();
        });

        // --- CARGA INICIAL DE DATOS Y RENDERIZADO ---
        console.log("Cargando datos iniciales...");
        await Promise.all([
            cargarTodosLosEmpleados(),
            cargarTodosLosFichajes(),
            cargarTodasLasVentas(),
            cargarTodasLasHabitaciones(),
            cargarTodosLosAnuncios(),
            cargarLibroNegro(),
            cargarListaNegra()
        ]);
        console.log("Carga de datos completada.");

        // Comprobar si hay una sesi√≥n activa
        const currentUser = sessionStorage.getItem('currentUser');
        if (currentUser && empleados.find(e => e.nombre === currentUser)) {
            mostrarPanelEmpleados(currentUser);
        } else {
            mostrarInicio();
        }
    });

  </script>
</body>
</html>
